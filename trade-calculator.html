<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Behavioral Trade Calculator - Owner Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #D4AF37; --dark-gold: #B8941E; --black: #0A0A0A;
            --off-black: #1A1A1A; --charcoal: #2A2A2A; --silver: #C0C0C0;
            --white: #FFFFFF; --win-green: #2ECC71; --loss-red: #E74C3C;
            --amber: #F0A500; --blue: #5DADE2;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Oswald', sans-serif; background: var(--black); color: var(--white); min-height: 100vh; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: rgba(212,175,55,0.05); }
        ::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 2px; }

        .page-header {
            background: linear-gradient(135deg, var(--off-black) 0%, var(--charcoal) 100%);
            border-bottom: 2px solid var(--gold);
            padding: 0.55rem 1rem;
            display: flex; align-items: center; gap: 0.7rem; flex-wrap: wrap; flex-shrink: 0;
        }
        .page-title {
            font-family: 'Bebas Neue', cursive; font-size: 1.2rem;
            color: var(--gold); letter-spacing: 0.12em; flex: 1; white-space: nowrap;
        }
        .back-btn {
            background: transparent; border: 1.5px solid var(--gold); color: var(--gold);
            font-family: 'Oswald', sans-serif; font-size: 0.7rem; font-weight: 600;
            padding: 0.32rem 0.65rem; border-radius: 4px; cursor: pointer;
            text-transform: uppercase; letter-spacing: 0.06em; flex-shrink: 0;
        }
        .back-btn:hover { background: rgba(212,175,55,0.1); }
        .league-select {
            background: var(--charcoal); border: 1.5px solid rgba(212,175,55,0.4);
            color: var(--white); font-family: 'Oswald', sans-serif; font-size: 0.76rem;
            padding: 0.32rem 0.55rem; border-radius: 4px; cursor: pointer; max-width: 220px;
        }
        .league-select:focus { outline: none; border-color: var(--gold); }

        .tab-bar {
            display: flex; background: var(--off-black);
            border-bottom: 2px solid rgba(212,175,55,0.2); overflow-x: auto;
        }
        .tab-btn {
            flex: 1; min-width: 100px; padding: 0.6rem 0.5rem; border: none; background: transparent;
            color: rgba(255,255,255,0.4); font-family: 'Oswald', sans-serif; font-size: 0.72rem;
            font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer;
            border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; white-space: nowrap;
        }
        .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }
        .tab-btn:hover:not(.active) { color: rgba(212,175,55,0.7); }

        .tab-content { padding: 0.75rem; max-width: 1400px; margin: 0 auto; }

        /* Team Grid */
        .team-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
        @media(min-width:600px){ .team-grid { grid-template-columns: 1fr 1fr; } }
        @media(min-width:900px){ .team-grid { grid-template-columns: repeat(3,1fr); } }
        @media(min-width:1200px){ .team-grid { grid-template-columns: repeat(4,1fr); } }

        /* Team Card */
        .team-card {
            background: var(--off-black); border: 1px solid rgba(212,175,55,0.2);
            border-radius: 8px; overflow: hidden; transition: border-color 0.2s;
        }
        .team-card:hover { border-color: rgba(212,175,55,0.5); }
        .team-card.my-team { border-color: var(--gold); box-shadow: 0 0 12px rgba(212,175,55,0.15); }
        .card-header {
            background: var(--charcoal); padding: 0.55rem 0.7rem;
            display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;
        }
        .card-owner { font-size: 0.85rem; font-weight: 700; color: var(--white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-teamname { font-size: 0.62rem; color: var(--silver); opacity: 0.7; margin-top: 0.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tier-badge {
            font-size: 0.58rem; font-weight: 700; letter-spacing: 0.08em;
            padding: 0.15rem 0.4rem; border-radius: 3px; flex-shrink: 0;
            border: 1px solid; text-transform: uppercase;
        }
        .card-body { padding: 0.6rem 0.7rem; display: flex; flex-direction: column; gap: 0.5rem; }

        .score-row { display: flex; align-items: center; gap: 0.5rem; }
        .score-label { font-size: 0.62rem; color: var(--silver); opacity: 0.7; width: 60px; flex-shrink: 0; }
        .score-bar-wrap { flex: 1; height: 6px; background: rgba(255,255,255,0.08); border-radius: 3px; overflow: hidden; }
        .score-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .score-val { font-size: 0.65rem; font-weight: 700; width: 32px; text-align: right; flex-shrink: 0; }

        /* Position rows */
        .pos-grid { display: flex; flex-direction: column; gap: 0.22rem; }
        .pos-row { display: flex; align-items: center; gap: 0.4rem; }
        .pos-label { font-size: 0.6rem; font-weight: 700; width: 20px; flex-shrink: 0; }
        .pos-dots { display: flex; gap: 2px; flex: 1; flex-wrap: wrap; }
        .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .dot-filled { background: var(--win-green); }
        .dot-empty  { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); }
        .dot-surplus{ background: var(--gold); }
        .pos-count { font-size: 0.58rem; width: 28px; text-align: right; flex-shrink: 0; }
        .pos-status-icon { font-size: 0.65rem; width: 14px; flex-shrink: 0; }

        /* Panic meter */
        .panic-row { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.2rem; }
        .panic-label { font-size: 0.6rem; color: var(--silver); opacity: 0.6; width: 40px; }
        .panic-dots { display: flex; gap: 3px; }
        .panic-dot { width: 9px; height: 9px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); }
        .panic-dot.lit { background: var(--loss-red); border-color: var(--loss-red); box-shadow: 0 0 4px rgba(231,76,60,0.6); }
        .panic-num { font-size: 0.62rem; color: var(--silver); opacity: 0.7; }

        /* Chips */
        .chip-row { display: flex; flex-wrap: wrap; gap: 0.25rem; }
        .chip { font-size: 0.55rem; font-weight: 700; letter-spacing: 0.05em; padding: 0.1rem 0.35rem; border-radius: 3px; text-transform: uppercase; }
        .chip-strength { background: rgba(46,204,113,0.15); border: 1px solid rgba(46,204,113,0.4); color: #2ECC71; }
        .chip-need { background: rgba(231,76,60,0.15); border: 1px solid rgba(231,76,60,0.4); color: #E74C3C; }
        .chip-thin { background: rgba(240,165,0,0.15); border: 1px solid rgba(240,165,0,0.4); color: #F0A500; }
        .chip-window { background: rgba(93,173,226,0.12); border: 1px solid rgba(93,173,226,0.3); color: #5DADE2; }
        .chip-dna { background: rgba(212,175,55,0.12); border: 1px solid rgba(212,175,55,0.3); color: var(--gold); }

        .record-row { display: flex; align-items: center; justify-content: space-between; }
        .record-text { font-size: 0.65rem; color: var(--silver); opacity: 0.8; }
        .pts-text { font-size: 0.6rem; color: var(--silver); opacity: 0.5; }

        /* Section header */
        .section-hdr {
            font-family: 'Bebas Neue', cursive; font-size: 0.9rem; color: var(--gold);
            letter-spacing: 0.12em; border-bottom: 1px solid rgba(212,175,55,0.2);
            padding-bottom: 0.3rem; margin-bottom: 0.6rem;
        }

        /* Filter bar */
        .filter-bar { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
        .filter-select {
            background: var(--charcoal); border: 1px solid rgba(212,175,55,0.3);
            color: var(--white); font-family: 'Oswald', sans-serif; font-size: 0.72rem;
            padding: 0.28rem 0.5rem; border-radius: 4px; cursor: pointer;
        }
        .filter-select:focus { outline: none; border-color: var(--gold); }

        /* Trade finder */
        .tf-layout { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media(min-width:768px){ .tf-layout { grid-template-columns: 280px 1fr; } }
        .tf-my-panel { background: var(--off-black); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; padding: 0.75rem; }
        .partner-list { display: flex; flex-direction: column; gap: 0.6rem; }
        .partner-card {
            background: var(--off-black); border: 1px solid rgba(212,175,55,0.15); border-radius: 8px;
            padding: 0.6rem 0.75rem; display: flex; flex-direction: column; gap: 0.4rem;
        }
        .partner-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
        .compat-bar-wrap { height: 5px; background: rgba(255,255,255,0.08); border-radius: 3px; overflow: hidden; }
        .compat-bar-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--gold), var(--win-green)); }
        .tf-exchange { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.15rem; }
        .tf-side { flex: 1; min-width: 120px; }
        .tf-side-label { font-size: 0.55rem; color: var(--silver); opacity: 0.5; margin-bottom: 0.2rem; text-transform: uppercase; letter-spacing: 0.06em; }
        .tax-warning { font-size: 0.6rem; color: var(--amber); margin-top: 0.25rem; opacity: 0.9; }

        /* DNA Cards */
        .dna-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
        @media(min-width:600px){ .dna-grid { grid-template-columns: 1fr 1fr; } }
        @media(min-width:900px){ .dna-grid { grid-template-columns: repeat(3,1fr); } }
        .dna-card {
            background: var(--off-black); border: 1px solid rgba(212,175,55,0.15);
            border-radius: 8px; padding: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem;
        }
        .dna-card.dna-set { border-color: rgba(212,175,55,0.4); }
        .dna-owner-row { display: flex; align-items: center; gap: 0.5rem; }
        .dna-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--charcoal); overflow: hidden; flex-shrink: 0; border: 1.5px solid rgba(212,175,55,0.3); }
        .dna-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .dna-select {
            width: 100%; background: var(--charcoal); border: 1px solid rgba(212,175,55,0.3);
            color: var(--white); font-family: 'Oswald', sans-serif; font-size: 0.72rem;
            padding: 0.28rem 0.45rem; border-radius: 4px; cursor: pointer;
        }
        .dna-select:focus { outline: none; border-color: var(--gold); }
        .dna-profile { background: rgba(212,175,55,0.06); border: 1px solid rgba(212,175,55,0.12); border-radius: 6px; padding: 0.5rem 0.6rem; }
        .dna-profile-title { font-size: 0.72rem; font-weight: 700; color: var(--gold); margin-bottom: 0.25rem; }
        .dna-profile-desc { font-size: 0.65rem; color: var(--silver); opacity: 0.85; line-height: 1.45; }
        .dna-taxes { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.15rem; }
        .tax-chip { font-size: 0.55rem; padding: 0.1rem 0.35rem; border-radius: 3px; border: 1px solid rgba(212,175,55,0.3); color: var(--amber); background: rgba(240,165,0,0.08); }

        /* Loading / error */
        .center-screen { min-height: 70vh; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.75rem; }
        .load-title { font-family: 'Bebas Neue', cursive; font-size: 1.4rem; color: var(--gold); letter-spacing: 0.12em; }
        .load-sub { font-size: 0.75rem; color: var(--silver); opacity: 0.5; }

        /* Summary bar */
        .summary-bar { display: flex; gap: 1rem; padding: 0.5rem 0.75rem; background: rgba(212,175,55,0.05); border: 1px solid rgba(212,175,55,0.1); border-radius: 6px; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .summary-stat { display: flex; flex-direction: column; align-items: center; }
        .summary-val { font-family: 'Bebas Neue', cursive; font-size: 1.1rem; color: var(--gold); }
        .summary-lbl { font-size: 0.55rem; color: var(--silver); opacity: 0.6; letter-spacing: 0.06em; text-transform: uppercase; }

        .my-team-badge { font-size: 0.55rem; background: var(--gold); color: var(--black); padding: 0.08rem 0.3rem; border-radius: 2px; font-weight: 700; letter-spacing: 0.04em; flex-shrink: 0; }

        .divider { height: 1px; background: rgba(212,175,55,0.1); margin: 0.25rem 0; }

        .proj-target { font-size: 0.62rem; margin-top: 0.1rem; }
        .proj-above { color: var(--win-green); }
        .proj-below { color: var(--loss-red); }
        .proj-close  { color: var(--amber); }

        .health-score { font-family: 'Bebas Neue', cursive; font-size: 1.6rem; line-height: 1; }

        .no-data-msg { text-align: center; color: var(--silver); opacity: 0.4; padding: 2rem 1rem; font-size: 0.78rem; }

        /* ── Trade Analyzer ─────────────────────────────────────────────────── */
        .ta-layout { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media(min-width:700px){ .ta-layout { grid-template-columns: 1fr 1fr; } }

        .ta-side { background: var(--off-black); border: 1px solid rgba(212,175,55,0.2); border-radius: 8px; padding: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .ta-side.side-a { border-color: rgba(93,173,226,0.35); }
        .ta-side.side-b { border-color: rgba(231,76,60,0.35); }

        .ta-search-wrap { position: relative; }
        .ta-search {
            width: 100%; background: var(--charcoal); border: 1px solid rgba(212,175,55,0.25);
            color: var(--white); font-family: 'Oswald', sans-serif; font-size: 0.78rem;
            padding: 0.4rem 0.6rem; border-radius: 4px;
        }
        .ta-search:focus { outline: none; border-color: var(--gold); }
        .ta-search::placeholder { color: rgba(255,255,255,0.25); }
        .ta-dropdown {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 100;
            background: var(--charcoal); border: 1px solid rgba(212,175,55,0.3);
            border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto;
        }
        .ta-dropdown-item {
            padding: 0.4rem 0.6rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.72rem; border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.12s;
        }
        .ta-dropdown-item:hover { background: rgba(212,175,55,0.1); }
        .ta-pos-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .ta-player-name { flex: 1; font-weight: 600; }
        .ta-player-meta { font-size: 0.6rem; color: var(--silver); opacity: 0.6; }
        .ta-player-val { font-size: 0.65rem; font-weight: 700; color: var(--gold); flex-shrink: 0; }

        .ta-player-row {
            background: var(--charcoal); border-radius: 5px; padding: 0.4rem 0.55rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .ta-remove { background: transparent; border: none; color: rgba(231,76,60,0.6); cursor: pointer; font-size: 0.75rem; flex-shrink: 0; padding: 0; }
        .ta-remove:hover { color: var(--loss-red); }
        .ta-val-bar-wrap { flex: 1; height: 4px; background: rgba(255,255,255,0.07); border-radius: 2px; overflow: hidden; }
        .ta-val-bar-fill { height: 100%; border-radius: 2px; transition: width 0.4s ease; }

        .ta-total-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.45rem 0.55rem; border-radius: 5px; margin-top: 0.25rem;
        }
        .ta-total-label { font-size: 0.65rem; color: var(--silver); opacity: 0.7; text-transform: uppercase; letter-spacing: 0.06em; }
        .ta-total-val { font-family: 'Bebas Neue', cursive; font-size: 1.3rem; }
        .ta-add-btn {
            background: transparent; border: 1px dashed rgba(212,175,55,0.3); color: rgba(212,175,55,0.5);
            font-family: 'Oswald', sans-serif; font-size: 0.7rem; padding: 0.3rem 0.6rem;
            border-radius: 4px; cursor: pointer; width: 100%; text-align: center; transition: all 0.15s;
        }
        .ta-add-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(212,175,55,0.06); }

        .ta-verdict {
            background: var(--off-black); border: 1px solid rgba(212,175,55,0.2); border-radius: 8px;
            padding: 0.75rem; display: flex; flex-direction: column; gap: 0.55rem; margin-top: 0.5rem;
        }
        .verdict-diff { font-family: 'Bebas Neue', cursive; font-size: 2rem; line-height: 1; }
        .verdict-label { font-size: 0.62rem; color: var(--silver); opacity: 0.6; margin-top: -0.1rem; text-transform: uppercase; letter-spacing: 0.06em; }
        .likelihood-bar-wrap { height: 10px; background: rgba(255,255,255,0.07); border-radius: 5px; overflow: hidden; }
        .likelihood-bar-fill { height: 100%; border-radius: 5px; transition: width 0.5s ease; }
        .dna-tax-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.65rem; padding: 0.2rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .dna-tax-label { color: var(--silver); opacity: 0.7; }
        .dna-tax-val { font-weight: 700; }
        .ta-owner-select {
            background: var(--charcoal); border: 1px solid rgba(212,175,55,0.25);
            color: var(--white); font-family: 'Oswald', sans-serif; font-size: 0.72rem;
            padding: 0.3rem 0.5rem; border-radius: 4px; cursor: pointer; width: 100%;
        }
        .ta-owner-select:focus { outline: none; border-color: var(--gold); }
        .ta-roster-filter {
            width: 100%; background: var(--charcoal);
            border: 1px solid rgba(212,175,55,0.25); border-bottom: 1px solid rgba(255,255,255,0.07);
            color: var(--white); font-family: 'Oswald', sans-serif; font-size: 0.75rem;
            padding: 0.38rem 0.6rem; border-radius: 4px 4px 0 0;
        }
        .ta-roster-filter:focus { outline: none; border-color: var(--gold); }
        .ta-roster-filter::placeholder { color: rgba(255,255,255,0.2); }
        .ta-roster-list {
            max-height: 210px; overflow-y: auto;
            background: var(--charcoal); border: 1px solid rgba(212,175,55,0.2);
            border-top: none; border-radius: 0 0 5px 5px;
        }
        .ta-roster-item {
            padding: 0.35rem 0.6rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.72rem; border-bottom: 1px solid rgba(255,255,255,0.04); transition: background 0.1s;
        }
        .ta-roster-item:hover:not(.added) { background: rgba(212,175,55,0.08); }
        .ta-roster-item.added { opacity: 0.3; cursor: default; pointer-events: none; }
        .ta-roster-empty { padding: 0.6rem; font-size: 0.65rem; color: var(--silver); opacity: 0.4; text-align: center; }
        .ta-mode-toggle { font-size: 0.58rem; color: rgba(212,175,55,0.55); cursor: pointer; text-align: right; padding: 0.1rem 0; text-decoration: underline; }
        .ta-mode-toggle:hover { color: var(--gold); }

        /* Posture badge */
        .posture-badge { font-size: 0.6rem; font-weight: 700; letter-spacing: 0.07em; padding: 0.18rem 0.45rem; border-radius: 3px; border: 1px solid; text-transform: uppercase; }

        /* Psych tax table */
        .tax-table { display: flex; flex-direction: column; gap: 0; border: 1px solid rgba(255,255,255,0.07); border-radius: 6px; overflow: hidden; }
        .tax-table-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.32rem 0.6rem; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.65rem; }
        .tax-table-row:last-child { border-bottom: none; }
        .tax-table-row.bonus { background: rgba(46,204,113,0.05); }
        .tax-table-row.tax   { background: rgba(231,76,60,0.05); }
        .tax-table-row.total { background: rgba(212,175,55,0.06); border-top: 1px solid rgba(212,175,55,0.2); font-weight: 700; }
        .tax-name  { flex: 1; font-weight: 600; }
        .tax-desc  { font-size: 0.58rem; color: var(--silver); opacity: 0.55; flex: 2; }
        .tax-val   { font-weight: 700; font-size: 0.7rem; width: 40px; text-align: right; flex-shrink: 0; }

        /* Grudge log */
        .grudge-log { display: flex; flex-direction: column; gap: 0.3rem; margin-top: 0.1rem; }
        .grudge-entry { display: flex; align-items: center; gap: 0.4rem; background: var(--charcoal); border-radius: 4px; padding: 0.3rem 0.5rem; font-size: 0.65rem; }
        .grudge-icon { font-size: 0.75rem; flex-shrink: 0; }
        .grudge-label { flex: 1; font-weight: 600; }
        .grudge-date  { font-size: 0.58rem; color: var(--silver); opacity: 0.5; }
        .grudge-impact{ font-weight: 700; font-size: 0.65rem; width: 32px; text-align: right; }
        .grudge-del   { background: transparent; border: none; color: rgba(231,76,60,0.4); cursor: pointer; font-size: 0.7rem; padding: 0 0.1rem; flex-shrink: 0; }
        .grudge-del:hover { color: var(--loss-red); }
        .grudge-add-row { display: flex; gap: 0.4rem; align-items: center; flex-wrap: wrap; margin-top: 0.25rem; }
        .grudge-type-btn {
            font-size: 0.6rem; font-weight: 700; padding: 0.22rem 0.5rem; border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.15); background: transparent; color: var(--silver);
            cursor: pointer; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.15s;
        }
        .grudge-type-btn:hover { border-color: var(--gold); color: var(--gold); }
        .log-section-hdr { font-size: 0.6rem; color: var(--silver); opacity: 0.5; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.2rem; }

        /* Outcome flow buttons */
        .outcome-btn {
            font-family: 'Oswald', sans-serif; font-size: 0.72rem; font-weight: 700;
            letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer;
            padding: 0.35rem 0.75rem; border-radius: 4px; border: 1.5px solid;
            transition: all 0.15s; background: transparent;
        }
        .outcome-btn:hover { filter: brightness(1.2); }
        .outcome-btn.primary  { color:#2ECC71; border-color:#2ECC71; }
        .outcome-btn.primary:hover { background:rgba(46,204,113,0.12); }
        .outcome-btn.danger   { color:#E74C3C; border-color:#E74C3C; }
        .outcome-btn.danger:hover  { background:rgba(231,76,60,0.12); }
        .outcome-btn.neutral  { color:#5DADE2; border-color:#5DADE2; }
        .outcome-btn.neutral:hover { background:rgba(93,173,226,0.12); }
        .outcome-btn.gold     { color:var(--gold); border-color:var(--gold); }
        .outcome-btn.gold:hover    { background:rgba(212,175,55,0.12); }
        .outcome-btn.amber    { color:#F0A500; border-color:#F0A500; }
        .outcome-btn.amber:hover   { background:rgba(240,165,0,0.12); }
        .outcome-btn.purple   { color:#BB8FCE; border-color:#BB8FCE; }
        .outcome-btn.purple:hover  { background:rgba(187,143,206,0.12); }
        .outcome-row { display:flex; gap:0.4rem; flex-wrap:wrap; }
        .outcome-question { font-size:0.68rem; color:var(--silver); opacity:0.8; margin-bottom:0.4rem; font-style:italic; }
        .back-link { background:transparent; border:none; color:rgba(255,255,255,0.3); font-size:0.62rem; cursor:pointer; padding:0.2rem 0; font-family:'Oswald',sans-serif; }
        .back-link:hover { color:var(--silver); }
        .counter-verdict-row { display:flex; align-items:center; gap:0.5rem; padding:0.4rem 0.6rem; border-radius:5px; }
        .derived-dna-chip { font-size:0.55rem; font-weight:700; padding:0.1rem 0.35rem; border-radius:3px; letter-spacing:0.05em; text-transform:uppercase; border:1px solid; }

        /* Source badge */
        .source-badge { font-size:0.45rem; background:rgba(240,165,0,0.15); border:1px solid rgba(240,165,0,0.35); color:var(--amber); padding:0.05rem 0.25rem; border-radius:2px; margin-left:0.2rem; letter-spacing:0.05em; }

        /* ── Guide Tab ─────────────────────────────────────────────────────── */
        .guide-hero { background:linear-gradient(135deg,rgba(212,175,55,0.08),rgba(212,175,55,0.02)); border:1px solid rgba(212,175,55,0.2); border-radius:10px; padding:1.25rem 1.5rem; margin-bottom:1.25rem; }
        .guide-hero-title { font-family:'Bebas Neue',cursive; font-size:1.6rem; color:var(--gold); letter-spacing:0.12em; margin-bottom:0.3rem; }
        .guide-hero-sub { font-size:0.72rem; color:var(--silver); opacity:0.75; line-height:1.55; max-width:700px; }
        .guide-grid { display:grid; grid-template-columns:1fr; gap:0.9rem; }
        @media(min-width:650px){ .guide-grid { grid-template-columns:1fr 1fr; } }
        @media(min-width:1050px){ .guide-grid { grid-template-columns:1fr 1fr 1fr; } }
        .guide-card { background:var(--off-black); border:1px solid rgba(212,175,55,0.15); border-radius:8px; padding:0.9rem 1rem; display:flex; flex-direction:column; gap:0.5rem; }
        .guide-card-title { font-family:'Bebas Neue',cursive; font-size:0.95rem; color:var(--gold); letter-spacing:0.1em; }
        .guide-step { display:flex; gap:0.6rem; align-items:flex-start; }
        .guide-step-num { font-family:'Bebas Neue',cursive; font-size:1.5rem; color:var(--gold); opacity:0.4; line-height:1; min-width:1.4rem; }
        .guide-step-body { flex:1; }
        .guide-step-title { font-size:0.75rem; font-weight:700; color:var(--white); margin-bottom:0.15rem; }
        .guide-step-desc { font-size:0.65rem; color:var(--silver); opacity:0.72; line-height:1.5; }
        .guide-metric-row { display:flex; gap:0.5rem; align-items:flex-start; margin-bottom:0.25rem; }
        .guide-metric-label { font-size:0.62rem; font-weight:700; color:var(--gold); min-width:80px; flex-shrink:0; }
        .guide-metric-val { font-size:0.62rem; color:var(--silver); opacity:0.75; line-height:1.45; flex:1; }
        .guide-tier-row { display:flex; align-items:center; gap:0.5rem; margin-bottom:0.25rem; }
        .guide-color-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
        .guide-dot-legend { display:flex; align-items:center; gap:0.4rem; margin-bottom:0.2rem; }

        /* ── Featured / Expanded Team Card ─────────────────────────────────── */
        .featured-wrap { display:grid; grid-template-columns:1fr; gap:1rem; background:var(--off-black); border:2px solid var(--gold); border-radius:10px; padding:1rem; margin-bottom:1.25rem; box-shadow:0 0 24px rgba(212,175,55,0.1); }
        @media(min-width:750px){ .featured-wrap { grid-template-columns:minmax(280px,340px) 1fr; } }
        .commentary-panel { display:flex; flex-direction:column; gap:0.6rem; }
        .commentary-card { background:rgba(212,175,55,0.04); border:1px solid rgba(212,175,55,0.1); border-radius:6px; padding:0.65rem 0.8rem; }
        .commentary-card-title { font-size:0.62rem; font-weight:700; color:var(--gold); text-transform:uppercase; letter-spacing:0.07em; margin-bottom:0.3rem; }
        .commentary-card-text { font-size:0.7rem; color:var(--silver); line-height:1.55; }
        .elite-tag { font-size:0.5rem; font-weight:700; background:rgba(212,175,55,0.18); border:1px solid rgba(212,175,55,0.45); color:var(--gold); padding:0.05rem 0.28rem; border-radius:3px; letter-spacing:0.05em; margin-left:0.3rem; vertical-align:middle; }
        .identity-badge { display:inline-block; font-family:'Bebas Neue',cursive; font-size:0.8rem; letter-spacing:0.1em; padding:0.2rem 0.6rem; border-radius:4px; border:1px solid; }

        /* Team detail expanded panel (for non-my-team) */
        .team-detail-panel { display:grid; grid-template-columns:1fr; gap:1rem; background:var(--off-black); border:1px solid rgba(212,175,55,0.35); border-radius:8px; padding:1rem; margin-bottom:1rem; }
        @media(min-width:750px){ .team-detail-panel { grid-template-columns:minmax(260px,310px) 1fr; } }
        .detail-close-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.5rem; }

        /* Larger team cards in grid */
        .team-card .card-owner { font-size:0.92rem; }
        .team-card .pos-label { font-size:0.65rem; }
        .team-card .pos-count { font-size:0.62rem; }
        .team-card .dot { width:9px; height:9px; }
        .team-card-link { background:transparent; border:1px solid rgba(212,175,55,0.25); color:rgba(212,175,55,0.6); font-family:'Oswald',sans-serif; font-size:0.62rem; font-weight:600; padding:0.22rem 0.55rem; border-radius:3px; cursor:pointer; text-transform:uppercase; letter-spacing:0.05em; transition:all 0.15s; width:100%; margin-top:0.1rem; }
        .team-card-link:hover { border-color:var(--gold); color:var(--gold); background:rgba(212,175,55,0.06); }

        /* ── Trade Finder — Partner Tiers ───────────────────────────────────── */
        .partner-card.optimal { border-color:rgba(46,204,113,0.45); background:rgba(46,204,113,0.02); }
        .optimal-badge { font-size:0.52rem; font-weight:700; background:rgba(46,204,113,0.15); border:1px solid rgba(46,204,113,0.45); color:#2ECC71; padding:0.08rem 0.32rem; border-radius:3px; letter-spacing:0.05em; text-transform:uppercase; }
        .partner-tier-label { font-size:0.65rem; font-weight:700; color:var(--silver); opacity:0.45; text-transform:uppercase; letter-spacing:0.08em; padding:0.5rem 0 0.35rem; border-bottom:1px solid rgba(255,255,255,0.06); margin-bottom:0.5rem; }

        /* ── Trade Analyzer — wider/larger ──────────────────────────────────── */
        .ta-layout-wide { display:grid; grid-template-columns:1fr; gap:1.25rem; }
        @media(min-width:700px){ .ta-layout-wide { grid-template-columns:1fr 1fr; } }
        .ta-side-locked { background:rgba(93,173,226,0.04); }
        .ta-roster-list-tall { max-height:300px; overflow-y:auto; background:var(--charcoal); border:1px solid rgba(212,175,55,0.2); border-top:none; border-radius:0 0 5px 5px; }
        .ta-pos-group-hdr { font-size:0.55rem; font-weight:700; color:var(--silver); opacity:0.5; padding:0.2rem 0.6rem; background:rgba(255,255,255,0.03); letter-spacing:0.06em; text-transform:uppercase; }
        .ta-analyzer-wrap { max-width:none; }

        /* ── Trade Analyzer — 3-column layout with scouting panel ─────────── */
        .ta-3col { display:grid; grid-template-columns:1fr; gap:1.25rem; }
        @media(min-width:800px){ .ta-3col { grid-template-columns:1fr 1fr; } }
        @media(min-width:1150px){ .ta-3col { grid-template-columns:1fr 1fr 300px; } }

        /* Scouting panel */
        .scout-panel { background:var(--off-black); border:1px solid rgba(212,175,55,0.2); border-radius:8px; padding:0.75rem; overflow-y:auto; max-height:660px; display:flex; flex-direction:column; gap:0.45rem; grid-row: 1; }
        @media(min-width:1150px){ .scout-panel { grid-column:3; grid-row:1; } }
        .scout-team-card { background:var(--charcoal); border:1px solid rgba(255,255,255,0.07); border-radius:6px; padding:0.6rem 0.7rem; cursor:pointer; transition:border-color 0.15s, background 0.15s; display:flex; flex-direction:column; gap:0.3rem; }
        .scout-team-card:hover { border-color:rgba(212,175,55,0.4); background:rgba(212,175,55,0.04); }
        .scout-team-card.scout-selected { border-color:var(--gold); background:rgba(212,175,55,0.08); }
        .scout-owner-row { display:flex; align-items:center; justify-content:space-between; gap:0.4rem; }
        .scout-owner-name { font-size:0.82rem; font-weight:700; color:var(--white); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .scout-chips { display:flex; flex-wrap:wrap; gap:0.2rem; margin-top:0.1rem; }

        /* Larger text across the whole analyzer */
        .ta-side { font-size:0.82rem; }
        .ta-player-row { padding:0.5rem 0.65rem; }
        .ta-roster-item { padding:0.42rem 0.7rem; font-size:0.8rem; }
        .ta-pos-group-hdr { font-size:0.65rem; padding:0.25rem 0.7rem; }
        .ta-total-label { font-size:0.72rem; }
        .ta-total-val { font-size:1.5rem; }
        .ta-roster-filter { font-size:0.8rem; padding:0.42rem 0.7rem; }
        .ta-search { font-size:0.82rem; padding:0.45rem 0.7rem; }
        .ta-dropdown-item { font-size:0.8rem; padding:0.45rem 0.7rem; }
        .ta-player-name { font-size:0.8rem; }
        .ta-player-meta { font-size:0.7rem; }
        .ta-player-val { font-size:0.72rem; }
        .verdict-diff { font-size:2.4rem; }
        .tax-table-row { font-size:0.72rem; padding:0.38rem 0.7rem; }
        .tax-name { font-size:0.72rem; }
        .tax-desc { font-size:0.65rem; }
        .tax-val  { font-size:0.78rem; }
        .outcome-btn { font-size:0.8rem; padding:0.42rem 0.9rem; }
        .outcome-question { font-size:0.75rem; }
        .log-section-hdr { font-size:0.68rem; }

        /* ── Trade Outcome / Trade Complete ──────────────────────────────────── */
        .trade-complete { display:flex; flex-direction:column; align-items:center; gap:0.8rem; padding:1.5rem 1rem; background:rgba(46,204,113,0.05); border:1px solid rgba(46,204,113,0.3); border-radius:8px; text-align:center; margin-top:0.5rem; }
        .trade-complete-icon { font-size:2.8rem; line-height:1; }
        .trade-complete-title { font-family:'Bebas Neue',cursive; font-size:2.2rem; color:var(--win-green); letter-spacing:0.12em; line-height:1; }
        .trade-complete-result { font-family:'Bebas Neue',cursive; font-size:1.1rem; letter-spacing:0.1em; padding:0.25rem 0.75rem; border-radius:4px; }
        .trade-complete-sub { font-size:0.7rem; color:var(--silver); opacity:0.7; line-height:1.5; max-width:400px; }
        .trade-players-wrap { display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; width:100%; }
        .trade-players-col { flex:1; min-width:150px; max-width:220px; text-align:left; }
        .trade-players-col-title { font-size:0.58rem; color:var(--silver); opacity:0.5; text-transform:uppercase; letter-spacing:0.06em; margin-bottom:0.35rem; }
        .trade-player-chip { font-size:0.65rem; background:var(--charcoal); border-radius:3px; padding:0.22rem 0.45rem; margin-bottom:0.2rem; display:flex; align-items:center; gap:0.35rem; }

        /* ── Grudge Log explainer ─────────────────────────────────────────── */
        .explainer-box { background:rgba(212,175,55,0.04); border:1px solid rgba(212,175,55,0.15); border-radius:6px; padding:0.75rem 0.9rem; margin-bottom:0.9rem; }
        .explainer-title { font-size:0.72rem; font-weight:700; color:var(--gold); margin-bottom:0.35rem; }
        .explainer-text { font-size:0.65rem; color:var(--silver); opacity:0.78; line-height:1.55; }
        .explainer-row { display:flex; align-items:flex-start; gap:0.45rem; margin-bottom:0.3rem; }
        .explainer-icon { flex-shrink:0; width:1.1rem; text-align:center; }
    </style>
</head>
<body>
<div id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;

// ─── AUTH ───────────────────────────────────────────────────────────────────
const AUTH_KEY = 'od_auth_v1';
const authRaw = localStorage.getItem(AUTH_KEY);
if (!authRaw) window.location.href = 'login.html';
let sleeperUsername = '';
try {
    sleeperUsername = JSON.parse(authRaw).username || '';
} catch(e) {
    localStorage.removeItem(AUTH_KEY);
    window.location.href = 'login.html';
}

// ─── SLEEPER API ─────────────────────────────────────────────────────────────
const SLEEPER_BASE = 'https://api.sleeper.app/v1';
async function apiFetch(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
}
const fetchUser       = u      => apiFetch(`${SLEEPER_BASE}/user/${encodeURIComponent(u)}`);
const fetchLeagues    = (uid,y) => apiFetch(`${SLEEPER_BASE}/user/${uid}/leagues/nfl/${y}`);
const fetchRosters    = id     => apiFetch(`${SLEEPER_BASE}/league/${id}/rosters`);
const fetchLeagueInfo = id     => apiFetch(`${SLEEPER_BASE}/league/${id}`);
const fetchLeagueUsers= id     => apiFetch(`${SLEEPER_BASE}/league/${id}/users`);

let _playersCache = null;
async function fetchPlayers() {
    if (_playersCache) return _playersCache;
    _playersCache = await apiFetch(`${SLEEPER_BASE}/players/nfl`);
    return _playersCache;
}
let _statsCache = {};
async function fetchSeasonStats(year) {
    if (_statsCache[year]) return _statsCache[year];
    try {
        _statsCache[year] = await apiFetch(`${SLEEPER_BASE}/stats/nfl/regular/${year}`);
    } catch(e) {
        console.warn('Stats fetch failed:', e);
        _statsCache[year] = {};
    }
    return _statsCache[year];
}

// ─── CONSTANTS ───────────────────────────────────────────────────────────────
const SEASON     = '2026';
const STATS_YEAR = '2025';

// Psycho League baseline (user-defined)
const WEEKLY_TARGET = 243;
const ANNUAL_TARGET = 3402;

// Ideal dynasty roster depth per position
const IDEAL_ROSTER = { QB:3, RB:7, WR:7, TE:4, K:2, DL:7, LB:6, DB:6 };

// Position importance weights (must sum to ~100 for coverage calc)
const POS_WEIGHTS = { QB:14, RB:14, WR:14, TE:8, K:3, DL:13, LB:10, DB:12 };
const TOTAL_WEIGHT = Object.values(POS_WEIGHTS).reduce((a,b)=>a+b,0);

const POS_ORDER = { QB:0, RB:1, WR:2, TE:3, K:4, DL:5, LB:6, DB:7 };

const DNA_TYPES = {
    NONE: { label: '— Not Set —', color: 'var(--silver)', desc: '', taxes: [] },
    FLEECER: {
        label: 'The Fleecer',
        color: '#E74C3C',
        desc: 'High activity, always hunting asymmetric value. Sends lowball offers constantly. Sharp but impatient — will counter-offer if you decline.',
        strategy: 'Counter with slightly above-fair value. They respect boldness. Never show urgency.',
        taxes: ['Endowment Effect +15%', 'Expects to "win" the trade'],
        multiplier: 0.85,
    },
    DOMINATOR: {
        label: 'The Dominator',
        color: '#E67E22',
        desc: 'High ego, requires a perceived +30% margin to pull the trigger. Motivated by status and bragging rights above all else.',
        strategy: 'Frame your offer as giving them the "better" side. Let them feel like they won.',
        taxes: ['Ego Premium +30%', 'Needs to feel superior', 'Grudge Tax if rejected'],
        multiplier: 0.75,
    },
    STALWART: {
        label: 'The Stalwart',
        color: '#5DADE2',
        desc: 'High stability, prefers 1-for-1 lateral moves. Emotionally attached to their roster. Slow to move but reliable when they engage.',
        strategy: 'Lead with fair value. Never low-ball. Highlight how the trade improves both sides equally.',
        taxes: ['Desire Tax on fan favorites', 'Prefers even-up deals'],
        multiplier: 1.0,
    },
    ACCEPTOR: {
        label: 'The Acceptor',
        color: '#2ECC71',
        desc: 'Low attachment, willing to sell current assets for future picks and young players. Rebuilding or just indifferent.',
        strategy: 'Offer future assets (picks, young upside). They discount current stars — exploit it.',
        taxes: ['Future Asset Bonus +20%', 'Discounts veterans -15%'],
        multiplier: 1.15,
    },
    DESPERATE: {
        label: 'The Desperate',
        color: '#BB8FCE',
        desc: 'High urgency triggered by injuries, bye-weeks, or playoff push. Will massively overpay for an immediate starter.',
        strategy: 'Identify their empty slot or injury. Strike fast — desperation fades after their bye.',
        taxes: ['Panic Multiplier up to +40%', 'Time-sensitive window'],
        multiplier: 1.3,
    },
};

// ─── GRUDGE TAX ───────────────────────────────────────────────────────────────
const GRUDGE_TYPES = {
    // ── Accepted outcomes ───────────────────────────────────────────────────
    ACCEPTED_FAIR: { label:'Accepted — Fair Trade',   impact:+5,  color:'#2ECC71', icon:'✓', cat:'accepted',
        dnaSignal:{ STALWART:3 } },
    ACCEPTED_WON:  { label:'Accepted — Fleeced Them', impact:-8,  color:'#E67E22', icon:'⬆', cat:'accepted',
        dnaSignal:{ FLEECER:3, DOMINATOR:1 } },
    ACCEPTED_LOST: { label:'Accepted — Got Fleeced',  impact:+10, color:'#BB8FCE', icon:'⬇', cat:'accepted',
        dnaSignal:{ ACCEPTOR:3, DESPERATE:2 } },
    // ── Rejected ────────────────────────────────────────────────────────────
    REJECTED:      { label:'Rejected',                 impact:-15, color:'#E74C3C', icon:'✗', cat:'rejected',
        dnaSignal:{ DOMINATOR:3, FLEECER:1 } },
    // ── Counter-offer outcomes ───────────────────────────────────────────────
    COUNTER_FAIR:     { label:'Counter — Fair',     impact:+3,  color:'#5DADE2', icon:'↔', cat:'counter',
        dnaSignal:{ STALWART:2, FLEECER:1 } },
    COUNTER_LOWBALL:  { label:'Counter — Lowball',  impact:-10, color:'#E67E22', icon:'↓', cat:'counter',
        dnaSignal:{ FLEECER:3, DOMINATOR:2 } },
};
const grudgeDecay = d => d < 30 ? 1.0 : d < 60 ? 0.6 : d < 90 ? 0.3 : 0.1;

const GRUDGE_KEY = lid => `od_grudges_v1_${lid}`;
function loadGrudges(lid) { try { return JSON.parse(localStorage.getItem(GRUDGE_KEY(lid)) || '[]'); } catch(e) { return []; } }
function saveGrudges(lid, data) { localStorage.setItem(GRUDGE_KEY(lid), JSON.stringify(data)); }

function calcGrudgeTax(myOwnerId, theirOwnerId, grudges, theirDnaKey) {
    if (!myOwnerId || !theirOwnerId) return { total:0, entries:[] };
    const relevant = grudges.filter(g => g.myOwnerId === myOwnerId && g.theirOwnerId === theirOwnerId);
    const dnaMult  = { FLEECER:0.7, DOMINATOR:1.6, STALWART:1.2, ACCEPTOR:0.8, DESPERATE:0.5, NONE:1.0 }[theirDnaKey] || 1.0;
    const now = Date.now();
    let total = 0;
    for (const g of relevant) {
        const ageDays = (now - new Date(g.date).getTime()) / 86400000;
        total += (GRUDGE_TYPES[g.type]?.impact || 0) * grudgeDecay(ageDays) * dnaMult;
    }
    return { total:Math.round(total), entries:relevant.sort((a,b) => new Date(b.date)-new Date(a.date)) };
}

// ─── OWNER POSTURE ────────────────────────────────────────────────────────────
const POSTURES = {
    DESPERATE: { label:'Desperate',    color:'#BB8FCE', desc:'Panic-mode — will overpay for immediate help. Strike now.' },
    BUYER:     { label:'Active Buyer', color:'#F0A500', desc:'Contender upgrading — open to deals, fair value required.' },
    NEUTRAL:   { label:'Neutral',      color:'#95A5A6', desc:'No strong directional push. Fair offers only.' },
    SELLER:    { label:'Active Seller',color:'#5DADE2', desc:'Moving assets for futures. Buy at a discount.' },
    LOCKED:    { label:'Locked In',    color:'#7F8C8D', desc:'Satisfied roster, high attachment. Very hard to move.' },
};
function calcOwnerPosture(assessment, dnaKey) {
    if (!assessment) return POSTURES.NEUTRAL;
    const { tier, panic } = assessment;
    if (panic >= 4)                                                   return POSTURES.DESPERATE;
    if (tier === 'REBUILDER' || dnaKey === 'ACCEPTOR')                return POSTURES.SELLER;
    if (tier === 'ELITE'     && panic <= 1)                           return POSTURES.LOCKED;
    if ((tier === 'CONTENDER' || tier === 'STAGNANT') && panic >= 2)  return POSTURES.BUYER;
    return POSTURES.NEUTRAL;
}

// ─── PSYCHOLOGICAL TAX ENGINE ─────────────────────────────────────────────────
function calcPsychTaxes(myAssessment, theirAssessment, theirDnaKey, theirPosture) {
    const taxes = [];
    // 1 — Endowment Effect: they overvalue what they own
    const ePct = { FLEECER:10, DOMINATOR:28, STALWART:20, ACCEPTOR:5, DESPERATE:15, NONE:12 }[theirDnaKey] || 12;
    taxes.push({ name:'Endowment Effect', impact:-Math.round(ePct/2), type:'TAX',
        desc:`~${ePct}% mental inflation on their own players. Their side feels worth more than market.` });
    // 2 — Panic Premium
    if (theirAssessment?.panic >= 3) {
        taxes.push({ name:'Panic Premium', impact:8+(theirAssessment.panic-2)*6, type:'BONUS',
            desc:`Panic ${theirAssessment.panic}/5 — urgency overrides normal caution.` });
    }
    // 3 — Status Tax (Dominator)
    if (theirDnaKey === 'DOMINATOR') {
        taxes.push({ name:'Status Tax', impact:-18, type:'TAX',
            desc:'Must visibly win the trade for ego/status. Frame it so they feel like the winner.' });
    }
    // 4 — Loss Aversion (Stalwart, Dominator)
    if (['STALWART','DOMINATOR'].includes(theirDnaKey)) {
        taxes.push({ name:'Loss Aversion', impact:-8, type:'TAX',
            desc:'Losing a familiar player hurts more than gaining a new one. Expect resistance.' });
    }
    // 5 — Rebuilding Discount (Acceptor)
    if (theirDnaKey === 'ACCEPTOR') {
        taxes.push({ name:'Rebuilding Discount', impact:+10, type:'BONUS',
            desc:'They mentally discount current starters. Buy at a discount in their mind.' });
    }
    // 6 — Need Fulfillment
    const myStrengths   = myAssessment?.strengths || [];
    const theirNeedPos  = theirAssessment?.needs?.slice(0,3).map(n=>n.pos) || [];
    if (theirNeedPos.some(p => myStrengths.includes(p))) {
        taxes.push({ name:'Need Fulfillment', impact:+12, type:'BONUS',
            desc:'Your surplus fills their critical positional gap — strong deal motivation.' });
    }
    // 7 — Trade Window
    if (myAssessment && theirAssessment) {
        if (myAssessment.window !== theirAssessment.window) {
            taxes.push({ name:'Window Alignment', impact:+8, type:'BONUS',
                desc:'Opposite windows (contender vs rebuilder) = natural asset exchange.' });
        } else {
            taxes.push({ name:'Window Friction', impact:-5, type:'TAX',
                desc:'Same trade window reduces natural motivation to exchange assets.' });
        }
    }
    // 8 — Posture
    if (theirPosture?.key === 'LOCKED') {
        taxes.push({ name:'Locked Roster Tax', impact:-12, type:'TAX',
            desc:'High satisfaction + attachment. Roster moves feel threatening to them.' });
    } else if (theirPosture?.key === 'SELLER') {
        taxes.push({ name:'Seller Momentum', impact:+10, type:'BONUS',
            desc:'Actively shopping. Trade conversations are welcomed.' });
    }
    return taxes;
}

// ─── AUTO-DERIVE DNA FROM HISTORY ────────────────────────────────────────────
// Tallies dnaSignal weights from all logged interactions against an owner.
// Returns a DNA key string when signal is strong enough, or null.
function deriveDNAFromHistory(theirOwnerId, allGrudges) {
    const entries = allGrudges.filter(g => g.theirOwnerId === theirOwnerId);
    if (entries.length < 3) return null;
    const scores = { FLEECER:0, DOMINATOR:0, STALWART:0, ACCEPTOR:0, DESPERATE:0 };
    for (const g of entries) {
        const sig = GRUDGE_TYPES[g.type]?.dnaSignal || {};
        for (const [dna, w] of Object.entries(sig)) scores[dna] = (scores[dna]||0) + w;
    }
    const ranked = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
    // Require ≥3 signal points and at least 50% more than the runner-up
    const [top, second] = ranked;
    if (top[1] < 3) return null;
    if (second && top[1] < second[1] * 1.5) return null; // too ambiguous
    return top[0];
}

// ─── STORAGE ─────────────────────────────────────────────────────────────────
const DNA_KEY = id => `od_owner_dna_v1_${id}`;
function loadDNA(lid) {
    try { return JSON.parse(localStorage.getItem(DNA_KEY(lid)) || '{}'); }
    catch(e) { return {}; }
}
function saveDNA(lid, data) {
    localStorage.setItem(DNA_KEY(lid), JSON.stringify(data));
}

// ─── FANTASYCALC MARKET VALUE ENGINE ─────────────────────────────────────────
// FantasyCalc public API — dynasty, 2QB/SuperFlex, full PPR
const FC_URL = 'https://api.fantasycalc.com/values/current?isDynasty=true&numQbs=2&ppr=1&superflex=true';
let _fcCache = null;

async function fetchFantasyCalcValues() {
    if (_fcCache) return _fcCache;
    try {
        const r = await fetch(FC_URL);
        if (!r.ok) throw new Error(`FC HTTP ${r.status}`);
        const data = await r.json();
        // Index by sleeperId for O(1) lookup
        const idx = {};
        for (const entry of data) {
            const sid = entry.player?.sleeperId || entry.player?.maybeSleeperID;
            if (sid) idx[String(sid)] = { value: entry.value || 0, trend: entry.trend30Day || 0, rank: entry.overallRank || 999, posRank: entry.positionRank || 999, source: 'fc' };
        }
        _fcCache = idx;
        return idx;
    } catch(e) {
        console.warn('FantasyCalc fetch failed:', e.message);
        _fcCache = {};
        return {};
    }
}

// Compute an internal value from stats percentile (0–9999 scale) as fallback for IDP/kickers
function buildInternalValues(playersData, statsData, scoring) {
    const byPos = {};
    for (const [id, p] of Object.entries(playersData)) {
        const np = normPos(p.position);
        if (!np) continue;
        const ppg = calcPPG(id, statsData, scoring);
        if (ppg <= 0) continue;
        if (!byPos[np]) byPos[np] = [];
        byPos[np].push({ id, ppg });
    }
    const idx = {};
    // Map PPG rank within position to a 0–8000 value scale
    for (const [, players] of Object.entries(byPos)) {
        const sorted = players.sort((a,b) => b.ppg - a.ppg);
        const total  = sorted.length;
        sorted.forEach(({ id, ppg }, rank) => {
            // Linear scale: rank 0 = 8000, rank=total-1 = 200
            const pct = total > 1 ? (1 - rank / (total - 1)) : 1;
            idx[id] = { value: Math.round(200 + pct * 7800), trend: 0, rank: rank + 1, posRank: rank + 1, source: 'internal' };
        });
    }
    return idx;
}

// Merge FC values (preferred) with internal fallback
function mergeValues(fcValues, internalValues) {
    const merged = { ...internalValues };
    for (const [sid, v] of Object.entries(fcValues)) {
        merged[sid] = v; // FC wins
    }
    return merged;
}

// Get player value from the merged index; returns { value, source }
function getPlayerValue(pid, valueIndex) {
    return valueIndex[String(pid)] || { value: 0, source: 'none' };
}

// Max value for bar scale (top player ~9500 in FC)
const MAX_VALUE = 10000;

// ─── UTILITIES ───────────────────────────────────────────────────────────────
function normPos(pos) {
    if (!pos) return null;
    if (['DB','CB','S','SS','FS'].includes(pos))                      return 'DB';
    if (['DL','DE','DT','NT','IDL','EDGE'].includes(pos))             return 'DL';
    if (['LB','OLB','ILB','MLB','EDGE'].includes(pos) && pos!=='EDGE')return 'LB';
    if (pos === 'EDGE') return 'DL'; // edge rushers slot as DL
    return pos; // QB, RB, WR, TE, K
}

function posColor(pos) {
    const c = { QB:'#FF6B6B', RB:'#4ECDC4', WR:'#45B7D1', TE:'#F7DC6F', K:'#BB8FCE', DL:'#E67E22', LB:'#F0A500', DB:'#5DADE2' };
    return c[pos] || 'var(--silver)';
}

function calcRawPts(stats, scoring) {
    if (!stats) return null;
    if (scoring) {
        let t = 0;
        for (const [f, w] of Object.entries(scoring)) {
            if (typeof w !== 'number') continue;
            if (stats[f] != null) t += Number(stats[f]) * w;
        }
        return t;
    }
    const p = stats.pts_half_ppr ?? stats.pts_ppr ?? stats.pts_std ?? null;
    return p !== null ? Number(p) : null;
}

function calcPPG(pid, statsData, scoring) {
    const s = statsData[pid];
    if (!s) return 0;
    const total = calcRawPts(s, scoring);
    const gp = s.gp || 0;
    if (total === null || gp === 0) return 0;
    return Math.max(0, total / gp);
}

function parseStarterSlots(rosterPositions) {
    const slots = {};
    for (const s of (rosterPositions || [])) {
        if (s === 'BN' || s === 'TAXI') continue;
        slots[s] = (slots[s] || 0) + 1;
    }
    return slots;
}

const FLEX_ALLOWED = {
    REC_FLEX:   ['WR','TE'],
    FLEX:       ['RB','WR','TE'],
    WRTQ:       ['QB','RB','WR','TE'],
    SUPER_FLEX: ['QB','RB','WR','TE'],
    IDP_FLEX:   ['DL','LB','DB'],
    WILDCARD:   ['QB','RB','WR','TE','K','DL','LB','DB'],
};

function calcOptimalLineup(playerIds, reserve, taxi, playersData, statsData, scoring, rosterPositions) {
    const resSet  = new Set(reserve || []);
    const taxiSet = new Set(taxi    || []);
    const active  = playerIds
        .filter(id => !resSet.has(id) && !taxiSet.has(id))
        .map(id => {
            const p = playersData[id];
            if (!p) return null;
            return { id, np: normPos(p.position), ppg: calcPPG(id, statsData, scoring) };
        })
        .filter(Boolean)
        .sort((a,b) => b.ppg - a.ppg);

    const slots = parseStarterSlots(rosterPositions);
    let total = 0;
    const used = new Set();

    // Specific position slots first
    for (const slot of ['QB','RB','WR','TE','K','DL','LB','DB','DEF']) {
        const count = slots[slot] || 0;
        let filled = 0;
        for (const p of active) {
            if (filled >= count) break;
            if (!used.has(p.id) && p.np === slot) { total += p.ppg; used.add(p.id); filled++; }
        }
    }

    // Flex slots — most restrictive first
    for (const [slot, allowed] of Object.entries(FLEX_ALLOWED)) {
        const count = slots[slot] || 0;
        for (let i = 0; i < count; i++) {
            for (const p of active) {
                if (!used.has(p.id) && allowed.includes(p.np)) {
                    total += p.ppg; used.add(p.id); break;
                }
            }
        }
    }
    return Math.round(total * 10) / 10;
}

function assessTeam(roster, playersData, statsData, leagueInfo, users) {
    const scoring   = leagueInfo?.scoring_settings;
    const rosterPos = leagueInfo?.roster_positions || [];
    const user      = users.find(u => u.user_id === roster.owner_id);
    const teamName  = user?.metadata?.team_name || `Team ${roster.roster_id}`;
    const ownerName = user?.display_name        || `Owner ${roster.roster_id}`;
    const avatar    = user?.avatar              || null;

    const wins   = roster.settings?.wins   || 0;
    const losses = roster.settings?.losses || 0;
    const ties   = roster.settings?.ties   || 0;
    const pf     = Number(roster.settings?.fpts || 0) + Number(roster.settings?.fpts_decimal || 0) / 100;

    // Group all players by normalized position (depth assessment)
    const posGroups = {};
    for (const id of (roster.players || [])) {
        const np = normPos(playersData[id]?.position);
        if (!np) continue;
        if (!posGroups[np]) posGroups[np] = [];
        posGroups[np].push(id);
    }

    // Assess each position vs ideal
    const posAssessment = {};
    for (const [pos, ideal] of Object.entries(IDEAL_ROSTER)) {
        const actual = (posGroups[pos] || []).length;
        const diff   = actual - ideal;
        let status;
        if      (diff >= 2)  status = 'surplus';
        else if (diff >= 0)  status = 'ok';
        else if (diff === -1) status = 'thin';
        else                  status = 'deficit';
        posAssessment[pos] = { actual, ideal, diff, status };
    }

    // Optimal weekly scoring
    const weeklyPts = calcOptimalLineup(
        roster.players || [], roster.reserve || [], roster.taxi || [],
        playersData, statsData, scoring, rosterPos
    );

    // Health score: 60% scoring + 40% coverage  (kept as a diagnostic 0-100 number)
    const scoringScore  = Math.min(60, (weeklyPts / WEEKLY_TARGET) * 60);
    let coverageScore   = 0;
    for (const [pos, { actual, ideal }] of Object.entries(posAssessment)) {
        coverageScore += Math.min(1, actual / ideal) * ((POS_WEIGHTS[pos]||0) / TOTAL_WEIGHT) * 40;
    }
    const healthScore = Math.round(scoringScore + coverageScore);

    // ── Tier classification ─────────────────────────────────────────────────
    // Driven PURELY by weekly scoring vs the 243 target so that deep dynasty
    // rosters don't inflate everyone into "Elite". Depth lives in healthScore
    // only as a diagnostic number.
    //
    // ELITE    ≥ 272  pts/wk  (≥12% above target)   ~top 2-4 teams
    // CONTENDER ≥ 243  pts/wk  (at/above target)      ~next 4-6 teams
    // STAGNANT  ≥ 207  pts/wk  (within 15% below)     ~next 4-6 teams
    // REBUILDER < 207  pts/wk  (>15% below target)    ~bottom 2-3 teams
    //
    // When scoring data is unavailable (weeklyPts=0), fall back to depth score.
    let tier, tierColor, tierBg;
    if (weeklyPts > 0) {
        if      (weeklyPts >= WEEKLY_TARGET * 1.12) { tier='ELITE';     tierColor='#D4AF37'; tierBg='rgba(212,175,55,0.15)'; }
        else if (weeklyPts >= WEEKLY_TARGET * 1.00) { tier='CONTENDER'; tierColor='#2ECC71'; tierBg='rgba(46,204,113,0.12)'; }
        else if (weeklyPts >= WEEKLY_TARGET * 0.85) { tier='STAGNANT';  tierColor='#F0A500'; tierBg='rgba(240,165,0,0.12)';  }
        else                                         { tier='REBUILDER'; tierColor='#E74C3C'; tierBg='rgba(231,76,60,0.12)';  }
    } else {
        // No scoring data yet — use depth coverage as proxy
        if      (coverageScore >= 36) { tier='CONTENDER'; tierColor='#2ECC71'; tierBg='rgba(46,204,113,0.12)'; }
        else if (coverageScore >= 26) { tier='STAGNANT';  tierColor='#F0A500'; tierBg='rgba(240,165,0,0.12)';  }
        else                           { tier='REBUILDER'; tierColor='#E74C3C'; tierBg='rgba(231,76,60,0.12)';  }
    }

    // Panic meter (0–5) — thresholds align with scoring tiers
    let panic = 0;
    if      (weeklyPts > 0 && weeklyPts < WEEKLY_TARGET * 0.85) panic += 2; // REBUILDER zone
    else if (weeklyPts > 0 && weeklyPts < WEEKLY_TARGET)        panic += 1; // STAGNANT zone
    const criticals = Object.values(posAssessment).filter(p => p.status === 'deficit').length;
    if      (criticals >= 3) panic += 2;
    else if (criticals >= 1) panic += 1;
    const played = wins + losses + ties;
    if (played > 0 && losses / played > 0.6) panic += 1;
    panic = Math.min(5, panic);

    // Trade window
    let window;
    if      (tier === 'ELITE' || (tier === 'CONTENDER' && panic <= 1))  window = 'CONTENDING';
    else if (tier === 'REBUILDER')                                       window = 'REBUILDING';
    else                                                                 window = 'TRANSITIONING';

    const needs     = Object.entries(posAssessment)
        .filter(([,v]) => v.status === 'deficit' || v.status === 'thin')
        .sort((a,b) => a[1].diff - b[1].diff)
        .map(([pos,v]) => ({ pos, urgency: v.status }));
    const strengths = Object.entries(posAssessment)
        .filter(([,v]) => v.status === 'surplus')
        .map(([pos]) => pos);

    return { rosterId:roster.roster_id, ownerId:roster.owner_id, teamName, ownerName, avatar, wins, losses, ties, pf,
             posGroups, posAssessment, weeklyPts, healthScore, tier, tierColor, tierBg, panic, window, needs, strengths };
}

// Top 5 players per position across all rosters = "elite"
function calcElitePlayers(assessments, valueIndex) {
    const byPos = {};
    for (const a of assessments) {
        for (const [pos, ids] of Object.entries(a.posGroups || {})) {
            if (!byPos[pos]) byPos[pos] = [];
            for (const id of ids) {
                const v = getPlayerValue(id, valueIndex);
                byPos[pos].push({ id, value: v.value });
            }
        }
    }
    const eliteSet = new Set();
    for (const players of Object.values(byPos)) {
        players.sort((a,b) => b.value - a.value).slice(0,5).forEach(p => eliteSet.add(p.id));
    }
    return eliteSet;
}

function countElite(assessment, eliteSet) {
    return Object.values(assessment.posGroups || {}).flat().filter(id => eliteSet.has(id)).length;
}

// Generate narrative commentary for a team
function teamCommentary(assessment, eliteSet) {
    const { weeklyPts, tier, needs, strengths, posAssessment, panic } = assessment;
    const eliteCount = countElite(assessment, eliteSet);
    const diff = weeklyPts - WEEKLY_TARGET;

    // Scoring
    let scoring;
    if (weeklyPts === 0) scoring = 'Weekly scoring data not yet available.';
    else if (diff >= 30) scoring = `Projecting ${weeklyPts} pts/week — ${diff.toFixed(0)} above the ${WEEKLY_TARGET} target. Elite-level output. Trade from a position of strength.`;
    else if (diff >= 10) scoring = `At ${weeklyPts} pts/week, you're ${diff.toFixed(0)} above the ${WEEKLY_TARGET} target. Comfortable floor. Stay the course.`;
    else if (diff >= -10) scoring = `Projecting ${weeklyPts} pts/week — right on the ${WEEKLY_TARGET} bubble. One key upgrade could push you into contention.`;
    else scoring = `At ${weeklyPts} pts/week, you're ${Math.abs(diff).toFixed(0)} below the ${WEEKLY_TARGET} target. Upgrading scoring output is priority one.`;

    // Elite players
    let elite;
    if (eliteCount >= 5) elite = `${eliteCount} elite players (top 5 at their position league-wide) anchor your lineup — an exceptional talent base.`;
    else if (eliteCount === 4) elite = `${eliteCount} elite players on your roster. Strong foundation — protect these assets in every negotiation.`;
    else if (eliteCount === 3) elite = `${eliteCount} elite-tier players give you real leverage. Identify the right trade to add a fourth.`;
    else if (eliteCount === 2) elite = `${eliteCount} elite players provide a solid core. Adding a third elite anchor would cement your competitive window.`;
    else if (eliteCount === 1) elite = `Only 1 elite player (top 5 at their position) currently on your squad. Acquiring a second cornerstone piece should be the primary target.`;
    else elite = `No players rank top 5 at their position league-wide yet. Trade strategy should target acquiring at least one elite anchor.`;

    // Strengths
    let strengthText;
    if (strengths.length === 0) strengthText = 'No positional surpluses — roster is relatively balanced without obvious trading chips.';
    else if (strengths.length === 1) strengthText = `${strengths[0]} depth is your primary trade currency. Use that surplus to target your areas of need.`;
    else strengthText = `Depth surplus at ${strengths.join(', ')} gives you multiple trading chips — you have leverage to be selective.`;

    // Needs
    const criticals = needs.filter(n => n.urgency === 'deficit');
    const thins = needs.filter(n => n.urgency === 'thin');
    let needsText;
    if (needs.length === 0) needsText = 'No major positional gaps. Balanced across the board — focus on reinforcing strengths.';
    else if (criticals.length > 0) needsText = `Critical shortage at ${criticals.map(n=>n.pos).join(', ')}${thins.length > 0 ? ` and running thin at ${thins.map(n=>n.pos).join(', ')}` : ''}. These are your priority targets.`;
    else needsText = `Running thin at ${thins.map(n=>n.pos).join(', ')} — not critical yet, but worth addressing before these become liabilities.`;

    // Tier identity
    const identities = {
        ELITE:     'Championship-caliber operation — trading from a position of strength.',
        CONTENDER: 'Legitimate playoff threat — at or above the scoring target, solid across the board.',
        STAGNANT:  'Stuck in the middle — below the scoring target with clear gaps to address before you fall further behind.',
        REBUILDER: 'Building for the future — position yourself as a willing seller for premium return.',
    };

    return { scoring, elite, strengthText, needsText, identity: identities[tier] || '', eliteCount };
}

function calcComplementarity(mine, theirs) {
    if (!mine || !theirs) return 0;
    let score = 0;
    for (const n of mine.needs) {
        const t = theirs.posAssessment[n.pos];
        if (t?.status === 'surplus') score += n.urgency === 'deficit' ? 25 : 12;
        else if (t?.status === 'ok' && n.urgency === 'deficit') score += 6;
    }
    for (const n of theirs.needs) {
        const m = mine.posAssessment[n.pos];
        if (m?.status === 'surplus') score += n.urgency === 'deficit' ? 25 : 12;
        else if (m?.status === 'ok' && n.urgency === 'deficit') score += 6;
    }
    if (mine.window !== theirs.window) score += 15;
    return Math.min(100, score);
}

function avatarUrl(id) {
    return id ? `https://sleepercdn.com/avatars/thumbs/${id}` : null;
}

// ─── SUB-COMPONENTS ──────────────────────────────────────────────────────────
function PosRow({ pos, assessment }) {
    const { actual, ideal, status } = assessment;
    const statusIcon = { surplus:'↑', ok:'✓', thin:'~', deficit:'✗' }[status];
    const statusColor = { surplus:'var(--gold)', ok:'var(--win-green)', thin:'var(--amber)', deficit:'var(--loss-red)' }[status];
    const dots = [];
    const maxDots = Math.max(ideal, actual);
    for (let i = 0; i < maxDots; i++) {
        if (i >= ideal) {
            dots.push(<span key={i} className="dot dot-surplus" title="Surplus player" />);
        } else if (i < actual) {
            dots.push(<span key={i} className="dot dot-filled" />);
        } else {
            dots.push(<span key={i} className="dot dot-empty" />);
        }
    }
    return (
        <div className="pos-row">
            <span className="pos-label" style={{ color: posColor(pos) }}>{pos}</span>
            <span className="pos-dots">{dots}</span>
            <span className="pos-count" style={{ color: statusColor }}>{actual}/{ideal}</span>
            <span className="pos-status-icon" style={{ color: statusColor }}>{statusIcon}</span>
        </div>
    );
}

function PanicMeter({ level }) {
    return (
        <div className="panic-row">
            <span className="panic-label">PANIC</span>
            <span className="panic-dots">
                {[1,2,3,4,5].map(i => <span key={i} className={`panic-dot${i<=level?' lit':''}`} />)}
            </span>
            <span className="panic-num">{level}/5</span>
        </div>
    );
}

function TeamCard({ assessment, isMyTeam, ownerDna }) {
    const { teamName, ownerName, wins, losses, ties, pf, weeklyPts, healthScore, tier, tierColor, tierBg,
            posAssessment, panic, window: tradeWindow, needs, strengths } = assessment;

    const dna   = DNA_TYPES[ownerDna] || DNA_TYPES.NONE;
    const pct   = Math.round((weeklyPts / WEEKLY_TARGET) * 100);
    const scoreBarColor = healthScore >= 85 ? '#D4AF37' : healthScore >= 70 ? '#2ECC71' : healthScore >= 55 ? '#F0A500' : '#E74C3C';
    const projClass = weeklyPts >= WEEKLY_TARGET ? 'proj-above' : weeklyPts >= WEEKLY_TARGET * 0.9 ? 'proj-close' : 'proj-below';

    return (
        <div className={`team-card${isMyTeam?' my-team':''}`}>
            <div className="card-header">
                <div style={{ overflow:'hidden' }}>
                    <div className="card-owner">{ownerName}</div>
                    <div className="card-teamname">{teamName}</div>
                </div>
                <div style={{ display:'flex', flexDirection:'column', alignItems:'flex-end', gap:'0.2rem', flexShrink:0 }}>
                    {isMyTeam && <span className="my-team-badge">MY TEAM</span>}
                    <span className="tier-badge" style={{ color:tierColor, borderColor:tierColor, background:tierBg }}>{tier}</span>
                </div>
            </div>
            <div className="card-body">
                {/* Health score + record */}
                <div className="record-row">
                    <span style={{ fontFamily:'Bebas Neue,cursive', fontSize:'1.5rem', color:scoreBarColor, lineHeight:1 }}>{healthScore}</span>
                    <div style={{ display:'flex', flexDirection:'column', alignItems:'flex-end' }}>
                        <span className="record-text">{wins}-{losses}{ties>0?`-${ties}`:''}</span>
                        <span className="pts-text">{pf > 0 ? `${pf.toFixed(0)} PF` : ''}</span>
                    </div>
                </div>

                {/* Weekly scoring potential bar */}
                <div className="score-row">
                    <span className="score-label">WEEKLY</span>
                    <div className="score-bar-wrap">
                        <div className="score-bar-fill" style={{ width:`${Math.min(100,pct)}%`, background:scoreBarColor }} />
                    </div>
                    <span className={`score-val ${projClass}`}>{weeklyPts > 0 ? weeklyPts : '—'}</span>
                </div>
                {weeklyPts > 0 && (
                    <div className={`proj-target ${projClass}`} style={{ fontSize:'0.58rem', marginTop:'-0.3rem' }}>
                        {weeklyPts >= WEEKLY_TARGET ? `+${(weeklyPts-WEEKLY_TARGET).toFixed(1)} vs ${WEEKLY_TARGET} target` : `-${(WEEKLY_TARGET-weeklyPts).toFixed(1)} below ${WEEKLY_TARGET} target`}
                    </div>
                )}
                {weeklyPts === 0 && <div style={{ fontSize:'0.58rem', color:'var(--silver)', opacity:0.4 }}>No stats available yet</div>}

                <div className="divider" />

                {/* Position health */}
                <div className="pos-grid">
                    {Object.entries(posAssessment)
                        .sort((a,b) => (POS_ORDER[a[0]]||9) - (POS_ORDER[b[0]]||9))
                        .map(([pos, data]) => <PosRow key={pos} pos={pos} assessment={data} />)
                    }
                </div>

                <div className="divider" />

                {/* Panic + window */}
                <PanicMeter level={panic} />
                <div className="chip-row">
                    <span className="chip chip-window">{tradeWindow}</span>
                    {ownerDna && ownerDna !== 'NONE' && <span className="chip chip-dna">{dna.label}</span>}
                </div>

                {/* Strengths / needs chips */}
                {strengths.length > 0 && (
                    <div className="chip-row">
                        {strengths.map(s => <span key={s} className="chip chip-strength">+{s}</span>)}
                    </div>
                )}
                {needs.length > 0 && (
                    <div className="chip-row">
                        {needs.map(n => (
                            <span key={n.pos} className={`chip ${n.urgency==='deficit'?'chip-need':'chip-thin'}`}>
                                {n.urgency==='deficit'?'⚠ ':''}{n.pos}
                            </span>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}

// ─── MAIN COMPONENT ──────────────────────────────────────────────────────────
function TradeCalculator() {
    const [phase, setPhase]   = useState('boot');
    const [errMsg, setErrMsg] = useState('');
    const [userId,  setUserId]  = useState('');
    const [leagues, setLeagues] = useState([]);
    const [leagueId, setLeagueId] = useState('');

    const [leagueInfo,  setLeagueInfo]  = useState(null);
    const [allRosters,  setAllRosters]  = useState([]);
    const [leagueUsers, setLeagueUsers] = useState([]);
    const [playersData, setPlayersData] = useState({});
    const [statsData,   setStatsData]   = useState({});
    const [loading,     setLoading]     = useState(false);

    const [activeTab,    setActiveTab]    = useState('guide');
    const [myRosterId,   setMyRosterId]   = useState(null);
    const [ownerDna,     setOwnerDna]     = useState({});   // { ownerId: DNA_TYPE_KEY }
    const [sortMode,     setSortMode]     = useState('health'); // health | panic | record
    const [tierFilter,   setTierFilter]   = useState('ALL');

    // Phase 2 — Trade Analyzer
    const [fcValues,      setFcValues]      = useState({});
    const [internalVals,  setInternalVals]  = useState({});
    const [tradeIds,      setTradeIds]      = useState({ A:[], B:[] });
    const [tradeOwner,    setTradeOwner]    = useState({ A:null, B:null });
    const [searchText,    setSearchText]    = useState({ A:'', B:'' });
    const [showSearch,    setShowSearch]    = useState({ A:false, B:false });

    // Phase 3 — Grudge Tax
    const [grudges,       setGrudges]       = useState([]);

    // Phase 4 — Outcome Flow
    const [outcomeStep,   setOutcomeStep]   = useState(null); // null | 'accepted' | 'counter' | 'done'
    const [tradeResult,   setTradeResult]   = useState(null); // { type, label, color }
    const [counterIds,    setCounterIds]    = useState({ A:[], B:[] });
    const [counterSearch, setCounterSearch] = useState({ A:'', B:'' });

    // Audit — expanded detail panel
    const [selectedAuditTeam, setSelectedAuditTeam] = useState(null); // rosterId

    // Bootstrap
    useEffect(() => { boot(); }, []);

    async function boot() {
        try {
            const user = await fetchUser(sleeperUsername);
            setUserId(user.user_id);
            const lgs = await fetchLeagues(user.user_id, SEASON);
            setLeagues(lgs || []);
            if (lgs?.length) {
                setLeagueId(lgs[0].league_id);
            }
            setPhase('ready');
        } catch(e) {
            setErrMsg('Failed to connect to Sleeper. Check your network and try again.');
            setPhase('error');
        }
    }

    useEffect(() => {
        if (!leagueId || !userId || phase !== 'ready') return;
        loadLeague();
    }, [leagueId, userId, phase]);

    async function loadLeague() {
        setLoading(true);
        setAllRosters([]); setLeagueUsers([]); setPlayersData({}); setStatsData({});
        setTradeIds({ A:[], B:[] }); setSearchText({ A:'', B:'' }); setShowSearch({ A:false, B:false });
        try {
            const [rosters, info, users, players, stats, fc] = await Promise.all([
                fetchRosters(leagueId),
                fetchLeagueInfo(leagueId),
                fetchLeagueUsers(leagueId),
                fetchPlayers(),
                fetchSeasonStats(STATS_YEAR),
                fetchFantasyCalcValues(),
            ]);
            const resolvedPlayers = players || {};
            const resolvedStats   = stats   || {};
            const scoring = info?.scoring_settings;
            setAllRosters(rosters || []);
            setLeagueInfo(info);
            setLeagueUsers(users || []);
            setPlayersData(resolvedPlayers);
            setStatsData(resolvedStats);
            setFcValues(fc);
            setInternalVals(buildInternalValues(resolvedPlayers, resolvedStats, scoring));

            // Find my roster
            const mine = (rosters || []).find(r => r.owner_id === userId);
            if (mine) setMyRosterId(mine.roster_id);

            // Load saved DNA profiles + grudge log
            setOwnerDna(loadDNA(leagueId));
            setGrudges(loadGrudges(leagueId));
        } catch(e) {
            console.error(e);
        } finally {
            setLoading(false);
        }
    }

    // Compute all team assessments
    const assessments = useMemo(() => {
        if (!allRosters.length || !leagueInfo) return [];
        return allRosters.map(r => assessTeam(r, playersData, statsData, leagueInfo, leagueUsers));
    }, [allRosters, playersData, statsData, leagueInfo, leagueUsers]);

    const myAssessment = useMemo(() =>
        assessments.find(a => a.rosterId === myRosterId) || null,
        [assessments, myRosterId]
    );

    // Auto-lock Side A to my team whenever my roster is identified
    useEffect(() => {
        if (myAssessment?.ownerId) {
            setTradeOwner(prev => ({ ...prev, A: myAssessment.ownerId }));
        }
    }, [myRosterId, assessments.length]); // eslint-disable-line

    // Merged market value index (FC preferred, internal fallback)
    const valueIndex = useMemo(() => mergeValues(fcValues, internalVals), [fcValues, internalVals]);

    // Elite player set — top 5 per position across all rosters
    const elitePlayerSet = useMemo(() => {
        if (!assessments.length || !Object.keys(valueIndex).length) return new Set();
        return calcElitePlayers(assessments, valueIndex);
    }, [assessments, valueIndex]);

    // Player search across all loaded players — QBs first, then sorted by value within each position group
    const playerSearchResults = useCallback((query) => {
        if (!query || query.length < 2) return [];
        const q = query.toLowerCase();
        return Object.entries(playersData)
            .filter(([, p]) => {
                if (!normPos(p.position)) return false;
                const full = `${p.first_name||''} ${p.last_name||''}`.toLowerCase();
                return full.includes(q) || (p.last_name||'').toLowerCase().startsWith(q);
            })
            .map(([id, p]) => {
                const v = getPlayerValue(id, valueIndex);
                return { id, name: `${p.first_name||''} ${p.last_name||''}`.trim(), pos: normPos(p.position), team: p.team||'FA', value: v.value, source: v.source };
            })
            .filter(p => p.value > 0 || query.length >= 3)
            .sort((a,b) => {
                const pd = (POS_ORDER[a.pos]||9) - (POS_ORDER[b.pos]||9);
                return pd !== 0 ? pd : b.value - a.value;
            })
            .slice(0, 20);
    }, [playersData, valueIndex]);

    // Total trade value for a side
    const tradeSideValue = useCallback((ids) => {
        return ids.reduce((sum, id) => sum + (getPlayerValue(id, valueIndex).value || 0), 0);
    }, [valueIndex]);

    // Sorted + filtered assessments for audit tab
    const sortedAssessments = useMemo(() => {
        let list = [...assessments];
        if (tierFilter !== 'ALL') list = list.filter(a => a.tier === tierFilter);
        if (sortMode === 'health') list.sort((a,b) => b.healthScore - a.healthScore);
        else if (sortMode === 'panic') list.sort((a,b) => b.panic - a.panic);
        else if (sortMode === 'record') list.sort((a,b) => b.wins - a.wins || b.pf - a.pf);
        return list;
    }, [assessments, sortMode, tierFilter]);

    // Trade partners ranked by complementarity
    const tradePartners = useMemo(() => {
        if (!myAssessment) return [];
        return assessments
            .filter(a => a.rosterId !== myRosterId)
            .map(a => ({ ...a, compat: calcComplementarity(myAssessment, a) }))
            .sort((a,b) => b.compat - a.compat);
    }, [assessments, myAssessment, myRosterId]);

    function updateDna(ownerId, dnaKey) {
        const updated = { ...ownerDna, [ownerId]: dnaKey };
        setOwnerDna(updated);
        saveDNA(leagueId, updated);
    }

    // Summary stats
    const avgHealth = assessments.length
        ? Math.round(assessments.reduce((s,a) => s + a.healthScore, 0) / assessments.length)
        : 0;
    const eliteCount = assessments.filter(a => a.tier === 'ELITE').length;
    const highPanic  = assessments.filter(a => a.panic >= 3).length;

    // ── RENDER ────────────────────────────────────────────────────────────────

    if (phase === 'boot') return (
        <div className="center-screen">
            <div className="load-title">BEHAVIORAL TRADE CALCULATOR</div>
            <div className="load-sub">Connecting to Sleeper API…</div>
        </div>
    );

    if (phase === 'error') return (
        <div className="center-screen">
            <div style={{ color:'var(--loss-red)', fontSize:'0.9rem', textAlign:'center', padding:'0 1rem' }}>{errMsg}</div>
            <button className="back-btn" onClick={() => window.location.href='index.html'}>← Back to Dashboard</button>
        </div>
    );

    // ── HOW-TO GUIDE TAB ──────────────────────────────────────────────────────
    function renderGuide() {
        return (
            <div>
                <div className="guide-hero">
                    <div className="guide-hero-title">Welcome to the Behavioral Trade Calculator</div>
                    <div className="guide-hero-sub">
                        This tool goes beyond raw player values — it analyzes your roster health, identifies ideal trading partners based on positional fit, profiles the psychology of each owner, and helps you understand not just <em>whether</em> to make a trade but <em>how</em> to win the negotiation. Here's how to use it.
                    </div>
                </div>

                <div className="guide-grid">
                    {/* Step 1 — League */}
                    <div className="guide-card">
                        <div className="guide-card-title">Step 1 — Select Your League</div>
                        <div className="guide-step">
                            <span className="guide-step-num">1</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">Choose a League</div>
                                <div className="guide-step-desc">Use the league selector in the top header to pick which Sleeper league to analyze. All data — rosters, stats, player values — loads automatically from Sleeper and FantasyCalc.</div>
                            </div>
                        </div>
                        <div className="guide-step">
                            <span className="guide-step-num">2</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">Wait for Data to Load</div>
                                <div className="guide-step-desc">First load takes a few seconds. Dynasty player values are pulled live from FantasyCalc (2QB/SF, full PPR). IDP and kickers fall back to an internal stats-based ranking.</div>
                            </div>
                        </div>
                    </div>

                    {/* Step 2 — Roster Audit */}
                    <div className="guide-card">
                        <div className="guide-card-title">Step 2 — Roster Audit</div>
                        <div className="guide-step">
                            <span className="guide-step-num">1</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">Your Team is Featured at the Top</div>
                                <div className="guide-step-desc">Your roster card sits prominently at the top with a full breakdown and commentary on scoring, strengths, needs, and elite player count. This is your baseline for every trade decision.</div>
                            </div>
                        </div>
                        <div className="guide-step">
                            <span className="guide-step-num">2</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">Read the Position Depth Grid</div>
                                <div className="guide-step-desc">Each position shows filled vs. target slots. Green = stocked. Gold = surplus (trade chip). Amber = thin. Red = critical shortage. A star icon marks elite players (top 5 at position league-wide).</div>
                            </div>
                        </div>
                        <div className="guide-step">
                            <span className="guide-step-num">3</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">View Any Team's Detail</div>
                                <div className="guide-step-desc">Click "View Detail" on any team card below to see their full assessment with the same commentary breakdown — useful for scouting potential trading partners.</div>
                            </div>
                        </div>
                    </div>

                    {/* Step 3 — Finding Your Trade Partner */}
                    <div className="guide-card">
                        <div className="guide-card-title">Step 3 — Finding Your Trade Partner</div>
                        <div className="guide-step">
                            <span className="guide-step-num">1</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">Use the League Scouting Panel</div>
                                <div className="guide-step-desc">Inside the Trade Analyzer, the right column shows every team in the league ranked by complementarity to your roster. Teams at the top have the most positional overlap — they need what you have and have what you need.</div>
                            </div>
                        </div>
                        <div className="guide-step">
                            <span className="guide-step-num">2</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">One Click to Load a Partner</div>
                                <div className="guide-step-desc">Click any team card in the scouting panel and their roster automatically loads into Side B. Their needs, tier, and posture are shown so you know exactly what to offer before building the deal.</div>
                            </div>
                        </div>
                    </div>

                    {/* Step 4 — Owner DNA */}
                    <div className="guide-card">
                        <div className="guide-card-title">Step 4 — Owner DNA</div>
                        <div className="guide-step">
                            <span className="guide-step-num">1</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">Profile Each Owner</div>
                                <div className="guide-step-desc">Select the DNA type that best fits how each owner behaves in trades. Five archetypes: Fleecer, Dominator, Stalwart, Acceptor, Desperate. These unlock psychological tax calculations throughout the app.</div>
                            </div>
                        </div>
                        <div className="guide-step">
                            <span className="guide-step-num">2</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">Log Every Interaction — the Grudge Log Learns</div>
                                <div className="guide-step-desc">After each trade attempt, log the outcome. As history builds (3+ interactions), the app auto-suggests a DNA profile based on patterns. Recent interactions carry more weight than old ones — scores decay over time.</div>
                            </div>
                        </div>
                    </div>

                    {/* Step 5 — Trade Analyzer */}
                    <div className="guide-card">
                        <div className="guide-card-title">Step 5 — Build and Analyze the Trade</div>
                        <div className="guide-step">
                            <span className="guide-step-num">1</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">Your Team is Pre-Loaded on the Left</div>
                                <div className="guide-step-desc">Side A is always your roster. Select the other owner on Side B, then click players from each roster list to build the deal. Players are organized by position group for easy browsing.</div>
                            </div>
                        </div>
                        <div className="guide-step">
                            <span className="guide-step-num">2</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">Read the Full Analysis</div>
                                <div className="guide-step-desc">The verdict panel shows: raw value differential, psychological tax breakdown (factors that affect real-world likelihood), acceptance probability, and a DNA-based approach strategy.</div>
                            </div>
                        </div>
                        <div className="guide-step">
                            <span className="guide-step-num">3</span>
                            <div className="guide-step-body">
                                <div className="guide-step-title">Log the Trade Outcome</div>
                                <div className="guide-step-desc">Use "Trade Outcome" after proposing the deal. If accepted, rate it Fair / Fleeced Them / Got Fleeced — this feeds the Grudge Log and improves future predictions for that owner.</div>
                            </div>
                        </div>
                    </div>

                    {/* Key Metrics */}
                    <div className="guide-card">
                        <div className="guide-card-title">Key Metrics &amp; Tiers</div>
                        <div style={{ marginBottom:'0.5rem' }}>
                            <div className="guide-metric-row"><span className="guide-metric-label">Health Score</span><span className="guide-metric-val">0–100 rating: 60% weekly scoring potential + 40% roster depth coverage</span></div>
                            <div className="guide-metric-row"><span className="guide-metric-label">Elite Players</span><span className="guide-metric-val">Top 5 players at each position across the entire league (marked ★)</span></div>
                            <div className="guide-metric-row"><span className="guide-metric-label">Panic Meter</span><span className="guide-metric-val">0–5 scale of trade urgency. High panic = willing to overpay</span></div>
                            <div className="guide-metric-row"><span className="guide-metric-label">Weekly Target</span><span className="guide-metric-val">{WEEKLY_TARGET} pts/week · {ANNUAL_TARGET} pts/season</span></div>
                        </div>
                        <div className="divider" />
                        <div style={{ marginTop:'0.4rem' }}>
                            {[
                                { tier:'ELITE',     color:'#D4AF37', score:`${Math.round(WEEKLY_TARGET*1.12)}+ pts/wk`, desc:`≥12% above ${WEEKLY_TARGET} target. Trade from strength.` },
                                { tier:'CONTENDER', color:'#2ECC71', score:`${WEEKLY_TARGET}+ pts/wk`,                  desc:`At/above target. Playoff-caliber, on track.` },
                                { tier:'STAGNANT',  color:'#F0A500', score:`${Math.round(WEEKLY_TARGET*0.85)}+ pts/wk`, desc:`Below target. In the mix but falling behind.` },
                                { tier:'REBUILDER', color:'#E74C3C', score:`<${Math.round(WEEKLY_TARGET*0.85)} pts/wk`, desc:`>15% below target. Build mode, willing sellers.` },
                            ].map(t => (
                                <div key={t.tier} className="guide-tier-row">
                                    <span className="guide-color-dot" style={{ background:t.color }} />
                                    <span style={{ fontSize:'0.65rem', fontWeight:700, color:t.color, minWidth:85 }}>{t.tier}</span>
                                    <span style={{ fontSize:'0.6rem', color:'var(--silver)', opacity:0.5, minWidth:40 }}>{t.score}</span>
                                    <span style={{ fontSize:'0.62rem', color:'var(--silver)', opacity:0.7 }}>{t.desc}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

                <div style={{ textAlign:'center', marginTop:'1.5rem' }}>
                    <button className="outcome-btn primary" onClick={() => setActiveTab('audit')} style={{ fontSize:'0.8rem', padding:'0.5rem 1.5rem' }}>
                        Start with Roster Audit →
                    </button>
                </div>
            </div>
        );
    }

    // ── ROSTER AUDIT TAB ──────────────────────────────────────────────────────
    function renderAudit() {
        if (loading) return <div className="center-screen"><div className="load-title">LOADING ROSTERS</div><div className="load-sub">Crunching {STATS_YEAR} stats…</div></div>;
        if (!assessments.length) return <div className="no-data-msg">No rosters found. Select a league above.</div>;

        // Helper: render commentary panel for any assessment
        function CommentaryPanel({ assessment }) {
            const commentary = teamCommentary(assessment, elitePlayerSet);
            const dnaKey = ownerDna[assessment.ownerId] || 'NONE';
            const dna    = DNA_TYPES[dnaKey] || DNA_TYPES.NONE;
            return (
                <div className="commentary-panel">
                    <div style={{ display:'flex', alignItems:'center', gap:'0.5rem', flexWrap:'wrap' }}>
                        <span className="identity-badge" style={{ color:assessment.tierColor, borderColor:assessment.tierColor, background:assessment.tierBg }}>
                            {assessment.tier}
                        </span>
                        <span style={{ fontSize:'0.68rem', color:'var(--silver)', opacity:0.7, fontStyle:'italic' }}>{commentary.identity}</span>
                    </div>
                    <div className="commentary-card">
                        <div className="commentary-card-title">Weekly Scoring</div>
                        <div className="commentary-card-text">{commentary.scoring}</div>
                    </div>
                    <div className="commentary-card">
                        <div className="commentary-card-title">
                            Elite Players
                            <span className="elite-tag">★ {commentary.eliteCount} ELITE</span>
                        </div>
                        <div className="commentary-card-text">{commentary.elite}</div>
                    </div>
                    <div className="commentary-card">
                        <div className="commentary-card-title">Trade Currency (Strengths)</div>
                        <div className="commentary-card-text">{commentary.strengthText}</div>
                    </div>
                    <div className="commentary-card">
                        <div className="commentary-card-title">Positional Needs</div>
                        <div className="commentary-card-text">{commentary.needsText}</div>
                    </div>
                    {dnaKey !== 'NONE' && dna.desc && (
                        <div className="commentary-card" style={{ borderColor:`${dna.color}30` }}>
                            <div className="commentary-card-title" style={{ color:dna.color }}>Owner DNA — {dna.label}</div>
                            <div className="commentary-card-text">{dna.strategy}</div>
                        </div>
                    )}
                </div>
            );
        }

        // Enhanced TeamCard with elite markers in pos rows
        function AuditPosRow({ pos, assessment }) {
            const { actual, ideal, status } = assessment;
            const statusIcon  = { surplus:'↑', ok:'✓', thin:'~', deficit:'✗' }[status];
            const statusColor = { surplus:'var(--gold)', ok:'var(--win-green)', thin:'var(--amber)', deficit:'var(--loss-red)' }[status];
            const dots = [];
            const maxDots = Math.max(ideal, actual);
            for (let i = 0; i < maxDots; i++) {
                if (i >= ideal) dots.push(<span key={i} className="dot dot-surplus" title="Surplus" />);
                else if (i < actual) dots.push(<span key={i} className="dot dot-filled" />);
                else dots.push(<span key={i} className="dot dot-empty" />);
            }
            return (
                <div className="pos-row">
                    <span className="pos-label" style={{ color:posColor(pos) }}>{pos}</span>
                    <span className="pos-dots">{dots}</span>
                    <span className="pos-count" style={{ color:statusColor }}>{actual}/{ideal}</span>
                    <span className="pos-status-icon" style={{ color:statusColor }}>{statusIcon}</span>
                </div>
            );
        }

        const selectedDetail = selectedAuditTeam ? assessments.find(a => a.rosterId === selectedAuditTeam) : null;

        return (
            <div>
                {/* Summary bar */}
                <div className="summary-bar">
                    <div className="summary-stat"><span className="summary-val">{assessments.length}</span><span className="summary-lbl">Teams</span></div>
                    <div className="summary-stat"><span className="summary-val">{avgHealth}</span><span className="summary-lbl">Avg Health</span></div>
                    <div className="summary-stat"><span className="summary-val">{eliteCount}</span><span className="summary-lbl">Elite Teams</span></div>
                    <div className="summary-stat"><span className="summary-val" style={{ color:'var(--loss-red)' }}>{highPanic}</span><span className="summary-lbl">High Panic</span></div>
                    <div className="summary-stat"><span className="summary-val">{WEEKLY_TARGET}</span><span className="summary-lbl">Wk Target</span></div>
                    <div className="summary-stat"><span className="summary-val">{elitePlayerSet.size}</span><span className="summary-lbl">Elite Players</span></div>
                </div>

                {/* ── MY TEAM — Featured ── */}
                {myAssessment && (
                    <div>
                        <div className="section-hdr" style={{ marginBottom:'0.6rem' }}>
                            MY TEAM
                            <span className="my-team-badge" style={{ marginLeft:'0.5rem', fontSize:'0.6rem', verticalAlign:'middle' }}>
                                {myAssessment.ownerName}
                            </span>
                        </div>
                        <div className="featured-wrap">
                            {/* Left: position depth card */}
                            <div>
                                <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'0.5rem' }}>
                                    <div>
                                        <div style={{ fontWeight:700, fontSize:'1rem' }}>{myAssessment.teamName}</div>
                                        <div style={{ fontSize:'0.65rem', color:'var(--silver)', opacity:0.6 }}>{myAssessment.wins}–{myAssessment.losses}{myAssessment.ties>0?`–${myAssessment.ties}`:''} · {myAssessment.pf > 0 ? `${myAssessment.pf.toFixed(0)} PF` : ''}</div>
                                    </div>
                                    <div style={{ textAlign:'right' }}>
                                        <div style={{ fontFamily:'Bebas Neue,cursive', fontSize:'2.2rem', lineHeight:1, color: myAssessment.healthScore>=85?'#D4AF37':myAssessment.healthScore>=70?'#2ECC71':myAssessment.healthScore>=55?'#F0A500':'#E74C3C' }}>
                                            {myAssessment.healthScore}
                                        </div>
                                        <div style={{ fontSize:'0.55rem', color:'var(--silver)', opacity:0.5 }}>HEALTH SCORE</div>
                                    </div>
                                </div>

                                {/* Weekly scoring */}
                                <div className="score-row" style={{ marginBottom:'0.25rem' }}>
                                    <span className="score-label">WEEKLY</span>
                                    <div className="score-bar-wrap">
                                        <div className="score-bar-fill" style={{ width:`${Math.min(100,Math.round((myAssessment.weeklyPts/WEEKLY_TARGET)*100))}%`, background: myAssessment.weeklyPts>=WEEKLY_TARGET?'var(--win-green)':'var(--loss-red)' }} />
                                    </div>
                                    <span className="score-val" style={{ color: myAssessment.weeklyPts>=WEEKLY_TARGET?'var(--win-green)':'var(--loss-red)' }}>{myAssessment.weeklyPts||'—'}</span>
                                </div>

                                <div className="divider" style={{ marginBottom:'0.5rem' }} />

                                {/* Position depth */}
                                <div style={{ fontSize:'0.6rem', color:'var(--silver)', opacity:0.45, marginBottom:'0.3rem' }}>
                                    ● Green=OK · ↑ Gold=Surplus · ~ Amber=Thin · ✗ Red=Critical · ★=Elite Player
                                </div>
                                <div className="pos-grid">
                                    {Object.entries(myAssessment.posAssessment)
                                        .sort((a,b)=>(POS_ORDER[a[0]]||9)-(POS_ORDER[b[0]]||9))
                                        .map(([pos, data]) => {
                                            // Count elite players for this position on my team
                                            const posIds = myAssessment.posGroups[pos] || [];
                                            const eliteHere = posIds.filter(id => elitePlayerSet.has(id)).length;
                                            return (
                                                <div key={pos} style={{ display:'flex', alignItems:'center', gap:'0.3rem' }}>
                                                    <div style={{ flex:1 }}><AuditPosRow pos={pos} assessment={data} /></div>
                                                    {eliteHere > 0 && <span title={`${eliteHere} elite player(s)`} style={{ fontSize:'0.65rem', color:'var(--gold)' }}>{'★'.repeat(eliteHere)}</span>}
                                                </div>
                                            );
                                        })
                                    }
                                </div>

                                <div className="divider" style={{ margin:'0.5rem 0' }} />
                                <PanicMeter level={myAssessment.panic} />
                            </div>

                            {/* Right: commentary */}
                            <CommentaryPanel assessment={myAssessment} />
                        </div>
                    </div>
                )}

                {/* ── EXPANDED DETAIL (selected other team) ── */}
                {selectedDetail && (
                    <div className="team-detail-panel">
                        <div style={{ gridColumn:'1/-1' }}>
                            <div className="detail-close-row">
                                <div style={{ fontWeight:700, fontSize:'0.9rem' }}>
                                    {selectedDetail.ownerName}
                                    <span style={{ fontSize:'0.65rem', color:'var(--silver)', opacity:0.6, marginLeft:'0.5rem' }}>{selectedDetail.teamName}</span>
                                </div>
                                <button className="back-btn" onClick={() => setSelectedAuditTeam(null)}>✕ Close</button>
                            </div>
                        </div>
                        {/* Left: position depth */}
                        <div>
                            <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'0.5rem' }}>
                                <div style={{ fontSize:'0.65rem', color:'var(--silver)', opacity:0.6 }}>{selectedDetail.wins}–{selectedDetail.losses} · {selectedDetail.pf>0?`${selectedDetail.pf.toFixed(0)} PF`:''}</div>
                                <div style={{ fontFamily:'Bebas Neue,cursive', fontSize:'1.8rem', lineHeight:1, color:selectedDetail.tierColor }}>{selectedDetail.healthScore}</div>
                            </div>
                            <div className="score-row" style={{ marginBottom:'0.4rem' }}>
                                <span className="score-label">WEEKLY</span>
                                <div className="score-bar-wrap"><div className="score-bar-fill" style={{ width:`${Math.min(100,Math.round((selectedDetail.weeklyPts/WEEKLY_TARGET)*100))}%`, background:selectedDetail.tierColor }} /></div>
                                <span className="score-val" style={{ color:selectedDetail.tierColor }}>{selectedDetail.weeklyPts||'—'}</span>
                            </div>
                            <div className="pos-grid">
                                {Object.entries(selectedDetail.posAssessment)
                                    .sort((a,b)=>(POS_ORDER[a[0]]||9)-(POS_ORDER[b[0]]||9))
                                    .map(([pos,data]) => {
                                        const posIds = selectedDetail.posGroups[pos] || [];
                                        const eliteHere = posIds.filter(id => elitePlayerSet.has(id)).length;
                                        return (
                                            <div key={pos} style={{ display:'flex', alignItems:'center', gap:'0.3rem' }}>
                                                <div style={{ flex:1 }}><AuditPosRow pos={pos} assessment={data} /></div>
                                                {eliteHere > 0 && <span style={{ fontSize:'0.65rem', color:'var(--gold)' }}>{'★'.repeat(eliteHere)}</span>}
                                            </div>
                                        );
                                    })
                                }
                            </div>
                            <div className="divider" style={{ margin:'0.5rem 0' }} />
                            <PanicMeter level={selectedDetail.panic} />
                        </div>
                        {/* Right: commentary */}
                        <CommentaryPanel assessment={selectedDetail} />
                    </div>
                )}

                {/* ── Filters + All Teams Grid ── */}
                <div className="section-hdr" style={{ marginBottom:'0.6rem' }}>ALL TEAMS</div>
                <div className="filter-bar">
                    <span style={{ fontSize:'0.68rem', color:'var(--silver)', opacity:0.6 }}>SORT</span>
                    <select className="filter-select" value={sortMode} onChange={e => setSortMode(e.target.value)}>
                        <option value="health">Health Score</option>
                        <option value="panic">Panic Level</option>
                        <option value="record">W-L Record</option>
                    </select>
                    <span style={{ fontSize:'0.68rem', color:'var(--silver)', opacity:0.6, marginLeft:'0.5rem' }}>TIER</span>
                    <select className="filter-select" value={tierFilter} onChange={e => setTierFilter(e.target.value)}>
                        <option value="ALL">All Tiers</option>
                        <option value="ELITE">Elite</option>
                        <option value="CONTENDER">Contender</option>
                        <option value="STAGNANT">Stagnant</option>
                        <option value="REBUILDER">Rebuilder</option>
                    </select>
                </div>
                <div style={{ fontSize:'0.6rem', color:'var(--silver)', opacity:0.4, marginBottom:'0.75rem', lineHeight:1.4 }}>
                    <strong style={{ color:'rgba(212,175,55,0.5)' }}>Tier = scoring vs {WEEKLY_TARGET} target:</strong> Elite ≥{Math.round(WEEKLY_TARGET*1.12)} · Contender ≥{WEEKLY_TARGET} · Stagnant ≥{Math.round(WEEKLY_TARGET*0.85)} · Rebuilder &lt;{Math.round(WEEKLY_TARGET*0.85)} pts/wk
                    &nbsp;·&nbsp; Health score = scoring (60%) + depth (40%) · ★ = top-5 at position league-wide
                </div>

                <div className="team-grid">
                    {sortedAssessments.map(a => {
                        const isMe = a.rosterId === myRosterId;
                        const eliteHere = countElite(a, elitePlayerSet);
                        return (
                            <div key={a.rosterId} style={{ display:'flex', flexDirection:'column', gap:'0.3rem' }}>
                                <TeamCard assessment={a} isMyTeam={isMe} ownerDna={ownerDna[a.ownerId]||'NONE'} />
                                {eliteHere > 0 && (
                                    <div style={{ textAlign:'center', fontSize:'0.6rem', color:'var(--gold)', letterSpacing:'0.05em' }}>
                                        {'★'.repeat(Math.min(eliteHere,5))} {eliteHere} ELITE PLAYER{eliteHere>1?'S':''}
                                    </div>
                                )}
                                {!isMe && (
                                    <button className="team-card-link" onClick={() => setSelectedAuditTeam(selectedAuditTeam === a.rosterId ? null : a.rosterId)}>
                                        {selectedAuditTeam === a.rosterId ? '▲ Hide Detail' : '▼ View Detail'}
                                    </button>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    }

    // ── TRADE FINDER TAB ──────────────────────────────────────────────────────
    function renderTradeFinder() {
        if (loading) return <div className="center-screen"><div className="load-title">LOADING</div></div>;
        if (!assessments.length) return <div className="no-data-msg">No roster data. Select a league above.</div>;

        // Roster selector
        const rosterOptions = assessments.map(a => ({ id: a.rosterId, label: `${a.ownerName} — ${a.teamName}` }));

        return (
            <div>
                <div className="filter-bar" style={{ marginBottom:'1rem' }}>
                    <span style={{ fontSize:'0.68rem', color:'var(--silver)', opacity:0.6 }}>MY TEAM</span>
                    <select className="filter-select" value={myRosterId || ''} onChange={e => setMyRosterId(Number(e.target.value))}>
                        {rosterOptions.map(o => <option key={o.id} value={o.id}>{o.label}</option>)}
                    </select>
                </div>

                {myAssessment ? (
                    <div className="tf-layout">
                        {/* My Panel */}
                        <div className="tf-my-panel">
                            <div className="section-hdr">MY ROSTER</div>
                            <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'0.5rem' }}>
                                <div>
                                    <div style={{ fontWeight:700, fontSize:'0.9rem' }}>{myAssessment.ownerName}</div>
                                    <div style={{ fontSize:'0.65rem', color:'var(--silver)', opacity:0.7 }}>{myAssessment.teamName}</div>
                                </div>
                                <span className="tier-badge" style={{ color:myAssessment.tierColor, borderColor:myAssessment.tierColor, background:myAssessment.tierBg }}>{myAssessment.tier}</span>
                            </div>

                            <div style={{ marginBottom:'0.5rem' }}>
                                <div style={{ fontSize:'0.62rem', color:'var(--silver)', opacity:0.6, marginBottom:'0.25rem' }}>WEEKLY PROJECTION</div>
                                <div style={{ fontFamily:'Bebas Neue,cursive', fontSize:'1.6rem', color: myAssessment.weeklyPts >= WEEKLY_TARGET ? 'var(--win-green)' : 'var(--loss-red)' }}>
                                    {myAssessment.weeklyPts > 0 ? myAssessment.weeklyPts : '—'}
                                    <span style={{ fontSize:'0.75rem', color:'var(--silver)', marginLeft:'0.3rem', opacity:0.6 }}>/ {WEEKLY_TARGET}</span>
                                </div>
                            </div>

                            <div className="section-hdr" style={{ fontSize:'0.72rem', marginTop:'0.5rem' }}>MY BIGGEST NEEDS</div>
                            {myAssessment.needs.length === 0
                                ? <div style={{ fontSize:'0.68rem', color:'var(--win-green)', opacity:0.8 }}>No major gaps — roster looks balanced</div>
                                : myAssessment.needs.slice(0,5).map(n => (
                                    <div key={n.pos} style={{ display:'flex', alignItems:'center', gap:'0.4rem', marginBottom:'0.3rem' }}>
                                        <span style={{ width:28, height:28, borderRadius:'50%', background:posColor(n.pos), display:'flex', alignItems:'center', justifyContent:'center', fontSize:'0.6rem', fontWeight:700, color:'var(--black)', flexShrink:0 }}>{n.pos}</span>
                                        <div>
                                            <div style={{ fontSize:'0.68rem', fontWeight:700 }}>
                                                {n.urgency==='deficit' ? 'CRITICAL SHORTAGE' : 'RUNNING THIN'}
                                            </div>
                                            <div style={{ fontSize:'0.58rem', color:'var(--silver)', opacity:0.7 }}>
                                                {myAssessment.posAssessment[n.pos].actual}/{myAssessment.posAssessment[n.pos].ideal} ideal depth
                                            </div>
                                        </div>
                                        <span className={`chip ${n.urgency==='deficit'?'chip-need':'chip-thin'}`} style={{ marginLeft:'auto' }}>
                                            {n.urgency==='deficit'?'CRITICAL':'THIN'}
                                        </span>
                                    </div>
                                ))
                            }

                            {myAssessment.strengths.length > 0 && (
                                <>
                                    <div className="section-hdr" style={{ fontSize:'0.72rem', marginTop:'0.75rem' }}>MY TRADE CURRENCY</div>
                                    <div className="chip-row">
                                        {myAssessment.strengths.map(s => <span key={s} className="chip chip-strength">+{s} SURPLUS</span>)}
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Trade Partner List */}
                        <div>
                            <div className="section-hdr">TRADE PARTNERS</div>
                            <div style={{ fontSize:'0.62rem', color:'var(--silver)', opacity:0.5, marginBottom:'0.75rem', lineHeight:1.45 }}>
                                <strong style={{ color:'#2ECC71' }}>Optimal Partners</strong> have genuine two-way positional fit — they need what you have <em>and</em> you need what they have. All others are ranked by partial complementarity.
                            </div>
                            {tradePartners.length === 0
                                ? <div className="no-data-msg">No potential partners found.</div>
                                : (() => {
                                    const optimal = tradePartners.filter(p => p.compat >= 50);
                                    const others  = tradePartners.filter(p => p.compat < 50);

                                    function PartnerRow({ partner }) {
                                        const dnaKey = ownerDna[partner.ownerId] || 'NONE';
                                        const dna    = DNA_TYPES[dnaKey] || DNA_TYPES.NONE;
                                        const isOptimal = partner.compat >= 50;
                                        const theyHelp = myAssessment.needs
                                            .filter(n => partner.posAssessment[n.pos]?.status === 'surplus' || partner.posAssessment[n.pos]?.status === 'ok')
                                            .map(n => n.pos);
                                        const iHelp = partner.needs
                                            .filter(n => myAssessment.posAssessment[n.pos]?.status === 'surplus' || myAssessment.posAssessment[n.pos]?.status === 'ok')
                                            .map(n => n.pos);
                                        const compatColor = partner.compat >= 70 ? 'var(--win-green)' : partner.compat >= 40 ? 'var(--amber)' : 'var(--loss-red)';
                                        return (
                                            <div className={`partner-card${isOptimal?' optimal':''}`}>
                                                <div className="partner-header">
                                                    <div>
                                                        <div style={{ fontWeight:700, fontSize:'0.88rem', display:'flex', alignItems:'center', gap:'0.35rem' }}>
                                                            {partner.ownerName}
                                                            {isOptimal && <span className="optimal-badge">OPTIMAL</span>}
                                                        </div>
                                                        <div style={{ fontSize:'0.62rem', color:'var(--silver)', opacity:0.6 }}>{partner.teamName}</div>
                                                    </div>
                                                    <div style={{ display:'flex', flexDirection:'column', alignItems:'flex-end', gap:'0.2rem' }}>
                                                        <span className="tier-badge" style={{ color:partner.tierColor, borderColor:partner.tierColor, background:partner.tierBg }}>{partner.tier}</span>
                                                        {dnaKey !== 'NONE' && <span className="chip chip-dna">{dna.label}</span>}
                                                    </div>
                                                </div>

                                                <div style={{ display:'flex', alignItems:'center', gap:'0.5rem' }}>
                                                    <span style={{ fontSize:'0.6rem', color:'var(--silver)', opacity:0.6, width:80, flexShrink:0 }}>COMPAT</span>
                                                    <div className="compat-bar-wrap" style={{ flex:1 }}>
                                                        <div className="compat-bar-fill" style={{ width:`${partner.compat}%` }} />
                                                    </div>
                                                    <span style={{ fontSize:'0.72rem', fontWeight:700, color:compatColor, width:32, textAlign:'right' }}>{partner.compat}%</span>
                                                </div>

                                                <div className="tf-exchange">
                                                    <div className="tf-side">
                                                        <div className="tf-side-label">They can provide</div>
                                                        <div className="chip-row">
                                                            {theyHelp.length > 0
                                                                ? theyHelp.map(p => <span key={p} className="chip chip-strength">{p}</span>)
                                                                : <span style={{ fontSize:'0.6rem', color:'var(--silver)', opacity:0.4 }}>No positional overlap</span>}
                                                        </div>
                                                    </div>
                                                    <div className="tf-side">
                                                        <div className="tf-side-label">You can provide</div>
                                                        <div className="chip-row">
                                                            {iHelp.length > 0
                                                                ? iHelp.map(p => <span key={p} className="chip chip-strength">{p}</span>)
                                                                : <span style={{ fontSize:'0.6rem', color:'var(--silver)', opacity:0.4 }}>No positional overlap</span>}
                                                        </div>
                                                    </div>
                                                </div>

                                                <div style={{ display:'flex', alignItems:'center', gap:'0.5rem', flexWrap:'wrap' }}>
                                                    <span className="chip chip-window">{partner.window}</span>
                                                    <span style={{ fontSize:'0.6rem', color:'var(--silver)', opacity:0.5 }}>Panic: {partner.panic}/5</span>
                                                    {partner.panic >= 3 && <span className="chip chip-need">HIGH URGENCY</span>}
                                                </div>

                                                {dnaKey !== 'NONE' && dna.strategy && (
                                                    <div className="tax-warning">Approach: {dna.strategy}</div>
                                                )}
                                                {dnaKey !== 'NONE' && dna.taxes?.length > 0 && (
                                                    <div className="dna-taxes">{dna.taxes.map((t,i) => <span key={i} className="tax-chip">{t}</span>)}</div>
                                                )}
                                            </div>
                                        );
                                    }

                                    return (
                                        <div className="partner-list">
                                            {optimal.length > 0 && (
                                                <>
                                                    <div className="partner-tier-label">★ Optimal Trading Partners ({optimal.length})</div>
                                                    {optimal.map(p => <PartnerRow key={p.rosterId} partner={p} />)}
                                                </>
                                            )}
                                            {others.length > 0 && (
                                                <>
                                                    <div className="partner-tier-label" style={{ marginTop: optimal.length ? '0.75rem' : 0 }}>
                                                        Other Potential Partners ({others.length})
                                                    </div>
                                                    {others.map(p => <PartnerRow key={p.rosterId} partner={p} />)}
                                                </>
                                            )}
                                        </div>
                                    );
                                })()
                            }
                        </div>
                    </div>
                ) : (
                    <div className="no-data-msg">Select your team above to find trade partners.</div>
                )}
            </div>
        );
    }

    // ── OWNER DNA TAB ─────────────────────────────────────────────────────────
    function renderOwnerDna() {
        if (loading) return <div className="center-screen"><div className="load-title">LOADING</div></div>;
        if (!assessments.length) return <div className="no-data-msg">No roster data. Select a league above.</div>;

        return (
            <div>
                {/* Owner DNA explainer */}
                <div className="explainer-box" style={{ marginBottom:'0.75rem' }}>
                    <div className="explainer-title">Owner DNA — How This Works</div>
                    <div className="explainer-text" style={{ marginBottom:'0.5rem' }}>
                        Profile each owner's trading personality. The DNA type you assign unlocks psychological tax calculations throughout the app — adjusting trade acceptance likelihood and telling you exactly <em>how</em> to approach each negotiation. Profiles are saved locally.
                    </div>
                    <div className="explainer-row">
                        <span className="explainer-icon">🎯</span>
                        <span className="explainer-text"><strong style={{ color:'var(--white)' }}>Start by estimating:</strong> Pick the DNA that best describes how this owner has behaved in past trades. It's a starting point — not a permanent label.</span>
                    </div>
                    <div className="explainer-row">
                        <span className="explainer-icon">📈</span>
                        <span className="explainer-text"><strong style={{ color:'var(--white)' }}>It grows over time:</strong> As you log trade outcomes in the Trade Analyzer, the app builds a behavioral history. After 3+ interactions, it auto-suggests a DNA type based on observed patterns (look for the <strong>AUTO</strong> badge).</span>
                    </div>
                </div>

                {/* Grudge Log explainer */}
                <div className="explainer-box" style={{ borderColor:'rgba(231,76,60,0.2)' }}>
                    <div className="explainer-title" style={{ color:'#E74C3C' }}>The Grudge Log — What It Means</div>
                    <div className="explainer-text" style={{ marginBottom:'0.5rem' }}>
                        Every logged trade interaction with an owner lives here. The Grudge Log is what makes this tool self-fulfilling — it learns your history and adjusts how likely that owner is to accept future offers.
                    </div>
                    <div className="explainer-row">
                        <span className="explainer-icon" style={{ color:'#2ECC71' }}>✓</span>
                        <span className="explainer-text"><strong style={{ color:'var(--white)' }}>Accepted — Fair Trade (+5):</strong> Mutual respect. Slightly positive — builds trust.</span>
                    </div>
                    <div className="explainer-row">
                        <span className="explainer-icon" style={{ color:'#E67E22' }}>⬆</span>
                        <span className="explainer-text"><strong style={{ color:'var(--white)' }}>Accepted — Fleeced Them (−8):</strong> You won the deal. They may be more cautious next time.</span>
                    </div>
                    <div className="explainer-row">
                        <span className="explainer-icon" style={{ color:'#BB8FCE' }}>⬇</span>
                        <span className="explainer-text"><strong style={{ color:'var(--white)' }}>Accepted — Got Fleeced (+10):</strong> They won. They'll be more willing to deal with you again.</span>
                    </div>
                    <div className="explainer-row">
                        <span className="explainer-icon" style={{ color:'#E74C3C' }}>✗</span>
                        <span className="explainer-text"><strong style={{ color:'var(--white)' }}>Rejected (−15):</strong> Hard no. Significant negative drag on future acceptance likelihood.</span>
                    </div>
                    <div style={{ marginTop:'0.4rem', fontSize:'0.62rem', color:'var(--silver)', opacity:0.6 }}>
                        All entries decay over time — interactions from 90+ days ago carry only 10% of their original weight. Recent history matters most.
                    </div>
                </div>

                <div style={{ fontSize:'0.65rem', color:'var(--silver)', opacity:0.55, marginBottom:'0.75rem', lineHeight:1.5 }}>
                    Profile each owner's behavioral DNA. This unlocks psychological tax calculations in the Trade Analyzer — telling you <em>how</em> to approach each deal, not just whether to make it. Profiles are saved locally.
                </div>
                <div className="dna-grid">
                    {assessments.map(a => {
                        const dnaKey     = ownerDna[a.ownerId] || 'NONE';
                        const dna        = DNA_TYPES[dnaKey];
                        const isMyTeam   = a.rosterId === myRosterId;
                        const avatarSrc  = avatarUrl(a.avatar);
                        return (
                            <div key={a.rosterId} className={`dna-card${dnaKey && dnaKey!=='NONE'?' dna-set':''}`}>
                                {/* Owner header */}
                                <div className="dna-owner-row">
                                    <div className="dna-avatar">
                                        {avatarSrc
                                            ? <img src={avatarSrc} alt={a.ownerName} onError={e => e.target.style.display='none'} />
                                            : <div style={{ width:'100%', height:'100%', display:'flex', alignItems:'center', justifyContent:'center', fontSize:'0.75rem', color:'var(--gold)', fontWeight:700 }}>
                                                {a.ownerName.charAt(0).toUpperCase()}
                                              </div>
                                        }
                                    </div>
                                    <div style={{ overflow:'hidden' }}>
                                        <div style={{ fontWeight:700, fontSize:'0.82rem', display:'flex', alignItems:'center', gap:'0.35rem' }}>
                                            {a.ownerName}
                                            {isMyTeam && <span className="my-team-badge">ME</span>}
                                        </div>
                                        <div style={{ fontSize:'0.6rem', color:'var(--silver)', opacity:0.6, whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis' }}>{a.teamName}</div>
                                    </div>
                                    <span className="tier-badge" style={{ marginLeft:'auto', flexShrink:0, color:a.tierColor, borderColor:a.tierColor, background:a.tierBg }}>{a.tier}</span>
                                </div>

                                {/* Posture */}
                                {(() => {
                                    const posture = calcOwnerPosture(a, dnaKey);
                                    return (
                                        <div style={{ display:'flex', alignItems:'center', gap:'0.4rem' }}>
                                            <span className="log-section-hdr" style={{ margin:0 }}>Posture:</span>
                                            <span className="posture-badge" style={{ color:posture.color, borderColor:posture.color, background:`${posture.color}18` }}>{posture.label}</span>
                                            <span style={{ fontSize:'0.58rem', color:'var(--silver)', opacity:0.45, fontStyle:'italic' }}>{posture.desc}</span>
                                        </div>
                                    );
                                })()}

                                {/* DNA Selector */}
                                <div>
                                    <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'0.2rem' }}>
                                        <span style={{ fontSize:'0.58rem', color:'var(--silver)', opacity:0.5, textTransform:'uppercase', letterSpacing:'0.06em' }}>Owner DNA</span>
                                        {(() => {
                                            const derived = deriveDNAFromHistory(a.ownerId, grudges);
                                            if (!derived) return null;
                                            const d = DNA_TYPES[derived];
                                            const isMatch = dnaKey === derived;
                                            return (
                                                <div style={{ display:'flex', alignItems:'center', gap:'0.3rem' }}>
                                                    <span className="derived-dna-chip" style={{ color:d?.color, borderColor:`${d?.color}55`, background:`${d?.color}10` }}>
                                                        AUTO: {d?.label}
                                                    </span>
                                                    {!isMatch && (
                                                        <button style={{ background:'transparent', border:'none', fontSize:'0.58rem', color:'var(--gold)', cursor:'pointer', textDecoration:'underline', padding:0 }}
                                                            onClick={() => updateDna(a.ownerId, derived)}>
                                                            Sync
                                                        </button>
                                                    )}
                                                </div>
                                            );
                                        })()}
                                    </div>
                                    <select
                                        className="dna-select"
                                        value={dnaKey}
                                        onChange={e => updateDna(a.ownerId, e.target.value)}
                                    >
                                        {Object.entries(DNA_TYPES).map(([k, v]) => (
                                            <option key={k} value={k}>{v.label}</option>
                                        ))}
                                    </select>
                                </div>

                                {/* DNA Profile */}
                                {dnaKey && dnaKey !== 'NONE' && dna.desc && (
                                    <div className="dna-profile">
                                        <div className="dna-profile-title" style={{ color: dna.color }}>{dna.label}</div>
                                        <div className="dna-profile-desc">{dna.desc}</div>
                                        {dna.strategy && (
                                            <div style={{ marginTop:'0.35rem', fontSize:'0.62rem', color: dna.color, opacity:0.9, fontStyle:'italic' }}>
                                                Strategy: {dna.strategy}
                                            </div>
                                        )}
                                        <div className="dna-taxes" style={{ marginTop:'0.4rem' }}>
                                            {dna.taxes?.map((t,i) => <span key={i} className="tax-chip">{t}</span>)}
                                        </div>
                                    </div>
                                )}

                                {/* Roster quick-stats */}
                                <div style={{ display:'flex', gap:'0.75rem', paddingTop:'0.25rem' }}>
                                    <div style={{ textAlign:'center' }}>
                                        <div style={{ fontFamily:'Bebas Neue,cursive', fontSize:'1rem', color:a.tierColor }}>{a.healthScore}</div>
                                        <div style={{ fontSize:'0.52rem', color:'var(--silver)', opacity:0.5 }}>HEALTH</div>
                                    </div>
                                    <div style={{ textAlign:'center' }}>
                                        <div style={{ fontFamily:'Bebas Neue,cursive', fontSize:'1rem', color: a.panic>=3?'var(--loss-red)':'var(--silver)' }}>{a.panic}/5</div>
                                        <div style={{ fontSize:'0.52rem', color:'var(--silver)', opacity:0.5 }}>PANIC</div>
                                    </div>
                                    <div style={{ textAlign:'center' }}>
                                        <div style={{ fontFamily:'Bebas Neue,cursive', fontSize:'1rem', color:'var(--silver)' }}>{a.wins}-{a.losses}</div>
                                        <div style={{ fontSize:'0.52rem', color:'var(--silver)', opacity:0.5 }}>RECORD</div>
                                    </div>
                                    <div style={{ textAlign:'center' }}>
                                        <div style={{ fontFamily:'Bebas Neue,cursive', fontSize:'1rem', color:'var(--silver)' }}>{a.weeklyPts > 0 ? a.weeklyPts : '—'}</div>
                                        <div style={{ fontSize:'0.52rem', color:'var(--silver)', opacity:0.5 }}>WK/PTS</div>
                                    </div>
                                </div>

                                {/* Grudge log — only show for other owners */}
                                {!isMyTeam && myAssessment && (() => {
                                    const myId    = myAssessment.ownerId;
                                    const theirId = a.ownerId;
                                    const relevant= grudges.filter(g => g.myOwnerId===myId && g.theirOwnerId===theirId);
                                    const gt      = calcGrudgeTax(myId, theirId, grudges, dnaKey);
                                    function addEntry(type) {
                                        const entry = { id:Date.now(), date:new Date().toISOString().slice(0,10), myOwnerId:myId, theirOwnerId:theirId, type };
                                        const updated = [...grudges, entry];
                                        setGrudges(updated); saveGrudges(leagueId, updated);
                                    }
                                    function delEntry(id) {
                                        const updated = grudges.filter(g => g.id !== id);
                                        setGrudges(updated); saveGrudges(leagueId, updated);
                                    }
                                    return (
                                        <div style={{ borderTop:'1px solid rgba(255,255,255,0.07)', paddingTop:'0.5rem', marginTop:'0.1rem' }}>
                                            <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'0.3rem' }}>
                                                <span className="log-section-hdr" style={{ margin:0 }}>Grudge Log</span>
                                                {gt.total !== 0 && (
                                                    <span style={{ fontSize:'0.62rem', fontWeight:700, color: gt.total<0?'var(--loss-red)':'var(--win-green)' }}>
                                                        Net: {gt.total>0?'+':''}{gt.total}
                                                    </span>
                                                )}
                                            </div>
                                            {relevant.length > 0 && (
                                                <div className="grudge-log" style={{ marginBottom:'0.35rem' }}>
                                                    {relevant.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(e => {
                                                        const g2 = GRUDGE_TYPES[e.type];
                                                        const ageDays = Math.round((Date.now()-new Date(e.date).getTime())/86400000);
                                                        return (
                                                            <div key={e.id} className="grudge-entry">
                                                                <span className="grudge-icon" style={{ color:g2?.color }}>{g2?.icon}</span>
                                                                <span className="grudge-label" style={{ color:g2?.color }}>{g2?.label}</span>
                                                                <span className="grudge-date">{e.date} · {ageDays}d</span>
                                                                <button className="grudge-del" onClick={() => delEntry(e.id)}>✕</button>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                            <div className="grudge-add-row">
                                                {Object.entries(GRUDGE_TYPES).map(([key, g2]) => (
                                                    <button key={key} className="grudge-type-btn"
                                                        style={{ borderColor:`${g2.color}55`, color:g2.color }}
                                                        onClick={() => addEntry(key)}>
                                                        {g2.icon} {g2.label}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    }

    // ── TRADE ANALYZER TAB ────────────────────────────────────────────────────
    function renderTradeAnalyzer() {
        if (loading) return <div className="center-screen"><div className="load-title">LOADING</div></div>;
        if (!Object.keys(playersData).length) return <div className="no-data-msg">No player data. Select a league above.</div>;

        const fcReady   = Object.keys(fcValues).length > 0;
        const totalA    = tradeSideValue(tradeIds.A);
        const totalB    = tradeSideValue(tradeIds.B);
        // diff = totalA - totalB = value the OTHER team gains (used for likelihood calc)
        // userGain = totalB - totalA = value YOU gain (used for display)
        const diff      = totalA - totalB;
        const userGain  = totalB - totalA;
        const absDiff   = Math.abs(userGain);
        const hasTrade  = tradeIds.A.length > 0 || tradeIds.B.length > 0;

        // DNA for the other owner
        const otherOwnerId  = tradeOwner.B;
        const otherDnaKey   = otherOwnerId ? (ownerDna[otherOwnerId] || 'NONE') : 'NONE';
        const otherDna      = DNA_TYPES[otherDnaKey] || DNA_TYPES.NONE;

        // Side A owner (default = me)
        const myOwnerId    = tradeOwner.A || (myAssessment?.ownerId || null);

        // ── Phase 3: Posture + Psych Taxes + Grudge Tax ──────────────────────────
        const theirAssessment = assessments.find(a => a.ownerId === otherOwnerId) || null;
        const theirPosture    = calcOwnerPosture(theirAssessment, otherDnaKey);
        const psychTaxes      = calcPsychTaxes(myAssessment, theirAssessment, otherDnaKey, theirPosture);
        const grudgeTax       = calcGrudgeTax(myOwnerId, otherOwnerId, grudges, otherDnaKey);
        const netTaxTotal     = psychTaxes.reduce((s,t) => s + t.impact, 0) + grudgeTax.total;
        const fairMargin      = Math.round(Math.max(totalA, totalB) * 0.04);

        // DNA-based acceptance curve
        let likelihood = 50;
        if (hasTrade && (totalA > 0 || totalB > 0)) {
            const maxSide        = Math.max(totalA, totalB, 1);
            const normalizedDiff = diff / maxSide;
            if (otherDnaKey === 'FLEECER') {
                likelihood = normalizedDiff < -0.05 ? 75 + Math.round(Math.abs(normalizedDiff)*40) : Math.max(15, 50 - Math.round(normalizedDiff*150));
            } else if (otherDnaKey === 'DOMINATOR') {
                likelihood = normalizedDiff < -0.10 ? 70 : normalizedDiff < 0 ? 55 : Math.max(10, 40 - Math.round(normalizedDiff*200));
            } else if (otherDnaKey === 'STALWART') {
                likelihood = Math.min(85, Math.max(20, Math.round((1 - Math.abs(normalizedDiff)*3)*80)));
            } else if (otherDnaKey === 'ACCEPTOR') {
                likelihood = Math.min(90, Math.max(30, 60 + Math.round(normalizedDiff*100)));
            } else if (otherDnaKey === 'DESPERATE') {
                const fitsNeed = theirAssessment?.needs?.some(n => (myAssessment?.strengths||[]).includes(n.pos));
                likelihood = fitsNeed ? Math.min(92, 65 + Math.round(Math.abs(normalizedDiff)*20) + 20) : Math.min(75, 55 + Math.round(Math.abs(normalizedDiff)*30));
            } else {
                likelihood = Math.min(85, Math.max(15, 50 - Math.round(normalizedDiff*120)));
            }
            likelihood += netTaxTotal;
        }
        likelihood = Math.round(Math.max(5, Math.min(97, likelihood)));

        function logGrudge(type) {
            if (!myOwnerId || !otherOwnerId) return;
            const entry = { id:Date.now(), date:new Date().toISOString().slice(0,10), myOwnerId, theirOwnerId:otherOwnerId, type };
            const updated = [...grudges, entry];
            setGrudges(updated); saveGrudges(leagueId, updated);
        }
        function deleteGrudge(id) {
            const updated = grudges.filter(g => g.id !== id);
            setGrudges(updated); saveGrudges(leagueId, updated);
        }

        const likelihoodColor = likelihood >= 70 ? 'var(--win-green)' : likelihood >= 45 ? 'var(--amber)' : 'var(--loss-red)';
        // verdictColor/Text use userGain (YOUR perspective): positive = you WIN
        const verdictColor = userGain > fairMargin ? 'var(--win-green)' : userGain < -fairMargin ? '#E74C3C' : 'var(--gold)';
        const verdictText  = userGain > fairMargin ? 'YOU WIN'          : userGain < -fairMargin ? 'YOU LOSE' : 'EVEN TRADE';
        const diffDisplay  = userGain > 0 ? `+${absDiff.toLocaleString()}` : userGain < 0 ? `-${absDiff.toLocaleString()}` : '±0';

        // Roster-specific player list — sorted by position group then value
        function rosterPlayersFor(side) {
            const ownerId = tradeOwner[side];
            if (!ownerId) return null; // null = use global search
            const roster = allRosters.find(r => r.owner_id === ownerId);
            if (!roster) return null;
            const playerIds = [
                ...(roster.players || []),
                ...(roster.reserve || []),
                ...(roster.taxi    || []),
            ];
            const q = searchText[side].toLowerCase().trim();
            return playerIds
                .filter(id => {
                    const p = playersData[id];
                    if (!p || !normPos(p.position)) return false;
                    if (q.length >= 1) {
                        const full = `${p.first_name||''} ${p.last_name||''}`.toLowerCase();
                        return full.includes(q);
                    }
                    return true;
                })
                .map(id => {
                    const p = playersData[id];
                    const v = getPlayerValue(id, valueIndex);
                    return { id, name:`${p.first_name||''} ${p.last_name||''}`.trim(), pos:normPos(p.position), team:p.team||'FA', value:v.value, source:v.source };
                })
                .sort((a,b) => {
                    const pd = (POS_ORDER[a.pos]||9) - (POS_ORDER[b.pos]||9);
                    return pd !== 0 ? pd : b.value - a.value;
                });
        }

        // Global search fallback (computed per side)
        const resultsA = playerSearchResults(searchText.A);
        const resultsB = playerSearchResults(searchText.B);

        function addPlayer(side, pid) {
            if (tradeIds[side].includes(pid)) return;
            setTradeIds(prev => ({ ...prev, [side]: [...prev[side], pid] }));
            setSearchText(prev => ({ ...prev, [side]: '' }));
            setShowSearch(prev => ({ ...prev, [side]: false }));
        }
        function removePlayer(side, pid) {
            setTradeIds(prev => ({ ...prev, [side]: prev[side].filter(id => id !== pid) }));
        }

        const ownerOptions = [
            { id: null,   label: '— None —' },
            ...assessments.map(a => ({ id: a.ownerId, label: `${a.ownerName} (${a.teamName})` })),
        ];

        function TradeSide({ side, color, label }) {
            const ids           = tradeIds[side];
            const tot           = tradeSideValue(ids);
            const srch          = searchText[side];
            const show          = showSearch[side];
            const rosterPlayers = rosterPlayersFor(side);
            const globalResults = side === 'A' ? resultsA : resultsB;
            const ownerSelected = !!tradeOwner[side];
            const isLockedSide  = side === 'A'; // Side A is always my team

            // Group roster players by position for display
            function RosterListGrouped({ players }) {
                if (!players || players.length === 0) return <div className="ta-roster-empty">No players match</div>;
                const grouped = {};
                players.forEach(r => { if (!grouped[r.pos]) grouped[r.pos] = []; grouped[r.pos].push(r); });
                return (
                    <>
                        {Object.entries(grouped)
                            .sort((a,b) => (POS_ORDER[a[0]]||9)-(POS_ORDER[b[0]]||9))
                            .map(([pos, posPlayers]) => (
                                <div key={pos}>
                                    <div className="ta-pos-group-hdr" style={{ color: posColor(pos) }}>{pos}</div>
                                    {posPlayers.map(r => {
                                        const added = ids.includes(r.id);
                                        return (
                                            <div key={r.id} className={`ta-roster-item${added?' added':''}`} onClick={() => !added && addPlayer(side, r.id)}>
                                                <span className="ta-pos-dot" style={{ background: posColor(r.pos) }} />
                                                <span style={{ flex:1, fontWeight:600, fontSize:'0.8rem', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' }}>{r.name}</span>
                                                <span className="ta-player-meta" style={{ fontSize:'0.68rem' }}>{r.team}</span>
                                                <span className="ta-player-val">
                                                    {r.value > 0 ? r.value.toLocaleString() : '—'}
                                                    {r.source === 'internal' && <span className="source-badge">INT</span>}
                                                    {elitePlayerSet.has(r.id) && <span style={{ marginLeft:'0.2rem', color:'var(--gold)' }}>★</span>}
                                                </span>
                                            </div>
                                        );
                                    })}
                                </div>
                            ))
                        }
                    </>
                );
            }

            return (
                <div className={`ta-side side-${side.toLowerCase()}${isLockedSide?' ta-side-locked':''}`}>
                    <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', gap:'0.5rem', flexWrap:'wrap' }}>
                        <span style={{ fontFamily:'Bebas Neue,cursive', fontSize:'0.95rem', color, letterSpacing:'0.08em' }}>{label}</span>
                        {isLockedSide
                            ? <span style={{ fontSize:'0.6rem', color, opacity:0.7, fontWeight:700, letterSpacing:'0.05em' }}>
                                MY TEAM {myAssessment ? `· ${myAssessment.ownerName}` : ''}
                              </span>
                            : <span style={{ fontSize:'0.6rem', color:'var(--silver)', opacity:0.5 }}>You receive</span>
                        }
                    </div>

                    {/* Owner selector — hidden for Side A (locked to my team) */}
                    {!isLockedSide && (
                        <select
                            className="ta-owner-select"
                            value={tradeOwner[side] || ''}
                            onChange={e => {
                                setTradeOwner(prev => ({ ...prev, [side]: e.target.value || null }));
                                setSearchText(prev => ({ ...prev, [side]: '' }));
                            }}
                        >
                            {ownerOptions.map(o => <option key={o.id||'none'} value={o.id||''}>{o.label}</option>)}
                        </select>
                    )}

                    {/* Added players */}
                    {ids.map(pid => {
                        const p   = playersData[pid];
                        const v   = getPlayerValue(pid, valueIndex);
                        const pct = Math.round((v.value / MAX_VALUE) * 100);
                        if (!p) return null;
                        return (
                            <div key={pid} className="ta-player-row">
                                <button className="ta-remove" onClick={() => removePlayer(side, pid)}>✕</button>
                                <span className="ta-pos-dot" style={{ background: posColor(normPos(p.position)) }} />
                                <span style={{ flex:1, fontSize:'0.82rem', fontWeight:600, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' }}>
                                    {p.first_name} {p.last_name}
                                    {elitePlayerSet.has(pid) && <span style={{ color:'var(--gold)', marginLeft:'0.25rem' }}>★</span>}
                                </span>
                                <div style={{ display:'flex', flexDirection:'column', alignItems:'flex-end', gap:2, width:80 }}>
                                    <div className="ta-val-bar-wrap">
                                        <div className="ta-val-bar-fill" style={{ width:`${pct}%`, background: color }} />
                                    </div>
                                    <span style={{ fontSize:'0.7rem', fontWeight:700, color }}>
                                        {v.value > 0 ? v.value.toLocaleString() : '—'}
                                        {v.source === 'internal' && <span className="source-badge">INT</span>}
                                    </span>
                                </div>
                            </div>
                        );
                    })}

                    {/* Roster picker or global search */}
                    {ownerSelected && rosterPlayers !== null ? (
                        <div>
                            <input
                                className="ta-roster-filter"
                                placeholder={`Filter ${rosterPlayers.length} players by position/name…`}
                                value={srch}
                                onChange={e => setSearchText(prev => ({ ...prev, [side]: e.target.value }))}
                            />
                            <div className="ta-roster-list-tall">
                                <RosterListGrouped players={rosterPlayers} />
                            </div>
                        </div>
                    ) : (
                        <div className="ta-search-wrap">
                            <input
                                className="ta-search"
                                placeholder={isLockedSide ? 'Loading your roster…' : 'Search any player to add…'}
                                value={srch}
                                onChange={e => { setSearchText(prev=>({...prev,[side]:e.target.value})); setShowSearch(prev=>({...prev,[side]:true})); }}
                                onFocus={() => setShowSearch(prev => ({...prev,[side]:true}))}
                                onBlur={() => setTimeout(() => setShowSearch(prev=>({...prev,[side]:false})), 200)}
                            />
                            {show && globalResults.length > 0 && (
                                <div className="ta-dropdown">
                                    {globalResults.map(r => (
                                        <div key={r.id} className="ta-dropdown-item" onMouseDown={() => addPlayer(side, r.id)}>
                                            <span className="ta-pos-dot" style={{ background: posColor(r.pos) }} />
                                            <span className="ta-player-name">{r.name}</span>
                                            <span className="ta-player-meta">{r.pos} · {r.team}</span>
                                            <span className="ta-player-val">{r.value > 0 ? r.value.toLocaleString() : '—'}</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Total */}
                    <div className="ta-total-row" style={{ background:`${color}12`, border:`1px solid ${color}30` }}>
                        <span className="ta-total-label">Total Value</span>
                        <span className="ta-total-val" style={{ color }}>{tot > 0 ? tot.toLocaleString() : '—'}</span>
                    </div>
                </div>
            );
        }

        return (
            <div>
                {/* Source indicator */}
                <div style={{ fontSize:'0.62rem', color:'var(--silver)', opacity:0.45, marginBottom:'0.75rem', lineHeight:1.5 }}>
                    {fcReady
                        ? <>Values sourced from <strong style={{ color:'var(--gold)' }}>FantasyCalc</strong> (dynasty 2QB/SF, full PPR). IDP &amp; kickers use internal stats-based ranking <span className="source-badge">INT</span>.</>
                        : <>FantasyCalc unavailable — showing internal stats-based values only <span className="source-badge">INT</span>. Values reflect 2025 PPG percentile rank.</>
                    }
                </div>

                {/* Trade sides + scouting panel */}
                <div className="ta-3col">
                    {TradeSide({ side:'A', color:'#5DADE2', label:'SIDE A — YOUR GIVE' })}
                    {TradeSide({ side:'B', color:'#E74C3C', label:'SIDE B — YOU RECEIVE' })}

                    {/* ── League Scouting Panel ── */}
                    <div className="scout-panel">
                        <div style={{ fontFamily:'Bebas Neue,cursive', fontSize:'0.92rem', color:'var(--gold)', letterSpacing:'0.1em', marginBottom:'0.2rem' }}>
                            LEAGUE TEAMS
                        </div>
                        <div style={{ fontSize:'0.62rem', color:'var(--silver)', opacity:0.5, marginBottom:'0.3rem', lineHeight:1.4 }}>
                            Click a team to set as Side B trading partner. Shows their key needs and surpluses.
                        </div>
                        {assessments
                            .filter(a => a.rosterId !== myRosterId)
                            .sort((a,b) => b.healthScore - a.healthScore)
                            .map(a => {
                                const isSelected = tradeOwner.B === a.ownerId;
                                const compat = myAssessment ? calcComplementarity(myAssessment, a) : 0;
                                const compatColor = compat >= 50 ? 'var(--win-green)' : compat >= 30 ? 'var(--amber)' : 'var(--silver)';
                                const dnaKey = ownerDna[a.ownerId] || 'NONE';
                                const dna    = DNA_TYPES[dnaKey];
                                return (
                                    <div
                                        key={a.rosterId}
                                        className={`scout-team-card${isSelected ? ' scout-selected' : ''}`}
                                        onClick={() => {
                                            setTradeOwner(prev => ({ ...prev, B: a.ownerId }));
                                            setSearchText(prev => ({ ...prev, B: '' }));
                                        }}
                                    >
                                        <div className="scout-owner-row">
                                            <span className="scout-owner-name">{a.ownerName}</span>
                                            <span className="tier-badge" style={{ color:a.tierColor, borderColor:a.tierColor, background:a.tierBg, flexShrink:0 }}>{a.tier}</span>
                                        </div>
                                        <div style={{ fontSize:'0.65rem', color:'var(--silver)', opacity:0.55, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' }}>{a.teamName}</div>

                                        {/* Weekly pts vs target */}
                                        <div style={{ fontSize:'0.65rem', display:'flex', alignItems:'center', gap:'0.4rem' }}>
                                            <span style={{ color: a.weeklyPts >= WEEKLY_TARGET ? 'var(--win-green)' : 'var(--loss-red)', fontWeight:700 }}>
                                                {a.weeklyPts > 0 ? `${a.weeklyPts} pts` : '—'}
                                            </span>
                                            <span style={{ color:'var(--silver)', opacity:0.4 }}>/ {WEEKLY_TARGET} target</span>
                                            {compat > 0 && (
                                                <span style={{ marginLeft:'auto', fontSize:'0.6rem', color:compatColor, fontWeight:700 }}>{compat}% fit</span>
                                            )}
                                        </div>

                                        {/* Needs */}
                                        {a.needs.length > 0 && (
                                            <div className="scout-chips">
                                                <span style={{ fontSize:'0.58rem', color:'var(--silver)', opacity:0.4, marginRight:'0.15rem' }}>NEEDS:</span>
                                                {a.needs.slice(0,4).map(n => (
                                                    <span key={n.pos} className={`chip ${n.urgency==='deficit'?'chip-need':'chip-thin'}`} style={{ fontSize:'0.55rem' }}>
                                                        {n.pos}
                                                    </span>
                                                ))}
                                            </div>
                                        )}

                                        {/* Strengths */}
                                        {a.strengths.length > 0 && (
                                            <div className="scout-chips">
                                                <span style={{ fontSize:'0.58rem', color:'var(--silver)', opacity:0.4, marginRight:'0.15rem' }}>HAS:</span>
                                                {a.strengths.map(s => (
                                                    <span key={s} className="chip chip-strength" style={{ fontSize:'0.55rem' }}>+{s}</span>
                                                ))}
                                            </div>
                                        )}

                                        {/* DNA */}
                                        {dnaKey !== 'NONE' && (
                                            <div style={{ fontSize:'0.6rem', color:dna.color, opacity:0.85, fontStyle:'italic', marginTop:'0.1rem' }}>
                                                {dna.label}
                                            </div>
                                        )}
                                    </div>
                                );
                            })
                        }
                    </div>
                </div>

                {/* Verdict panel */}
                {hasTrade && (
                    <div className="ta-verdict">
                        <div className="section-hdr">TRADE ANALYSIS</div>

                        {/* Value differential */}
                        <div style={{ display:'flex', alignItems:'baseline', gap:'0.6rem', flexWrap:'wrap' }}>
                            <span className="verdict-diff" style={{ color: verdictColor }}>{diffDisplay}</span>
                            <span style={{ fontFamily:'Bebas Neue,cursive', fontSize:'1.1rem', color: verdictColor }}>{verdictText}</span>
                            <span style={{ fontSize:'0.62rem', color:'var(--silver)', opacity:0.55 }}>
                                (gave {totalA.toLocaleString()} · received {totalB.toLocaleString()})
                            </span>
                        </div>

                        {/* Owner posture + DNA */}
                        {otherOwnerId && (
                            <div style={{ display:'flex', alignItems:'center', gap:'0.5rem', flexWrap:'wrap' }}>
                                <span style={{ fontSize:'0.6rem', color:'var(--silver)', opacity:0.5 }}>Their posture:</span>
                                <span className="posture-badge" style={{ color:theirPosture.color, borderColor:theirPosture.color, background:`${theirPosture.color}18` }}>{theirPosture.label}</span>
                                {otherDnaKey !== 'NONE' && <span className="chip chip-dna">{otherDna.label}</span>}
                                <span style={{ fontSize:'0.58rem', color:'var(--silver)', opacity:0.45, fontStyle:'italic' }}>{theirPosture.desc}</span>
                            </div>
                        )}

                        {/* Psychological Tax Breakdown */}
                        <div>
                            <div className="log-section-hdr" style={{ marginBottom:'0.35rem' }}>Psychological Tax Breakdown</div>
                            <div className="tax-table">
                                {psychTaxes.map((t,i) => (
                                    <div key={i} className={`tax-table-row ${t.type === 'BONUS' ? 'bonus' : 'tax'}`}>
                                        <span className="tax-name">{t.name}</span>
                                        <span className="tax-desc">{t.desc}</span>
                                        <span className="tax-val" style={{ color: t.impact > 0 ? 'var(--win-green)' : 'var(--loss-red)' }}>
                                            {t.impact > 0 ? '+' : ''}{t.impact}
                                        </span>
                                    </div>
                                ))}
                                {grudgeTax.total !== 0 && (
                                    <div className={`tax-table-row ${grudgeTax.total < 0 ? 'tax' : 'bonus'}`}>
                                        <span className="tax-name">Grudge Tax</span>
                                        <span className="tax-desc">{grudgeTax.entries.length} logged interaction{grudgeTax.entries.length!==1?'s':''}, decay-weighted</span>
                                        <span className="tax-val" style={{ color: grudgeTax.total < 0 ? 'var(--loss-red)' : 'var(--win-green)' }}>
                                            {grudgeTax.total > 0 ? '+' : ''}{grudgeTax.total}
                                        </span>
                                    </div>
                                )}
                                <div className="tax-table-row total">
                                    <span className="tax-name">NET MODIFIER</span>
                                    <span className="tax-desc">Applied to base likelihood</span>
                                    <span className="tax-val" style={{ color: netTaxTotal > 0 ? 'var(--win-green)' : netTaxTotal < 0 ? 'var(--loss-red)' : 'var(--silver)' }}>
                                        {netTaxTotal > 0 ? '+' : ''}{netTaxTotal}
                                    </span>
                                </div>
                            </div>
                        </div>

                        {/* Strategy tip */}
                        {otherDnaKey !== 'NONE' && otherDna.strategy && (
                            <div style={{ fontSize:'0.65rem', color:otherDna.color, fontStyle:'italic', background:`${otherDna.color}0d`, border:`1px solid ${otherDna.color}25`, borderRadius:5, padding:'0.4rem 0.6rem' }}>
                                Approach: {otherDna.strategy}
                            </div>
                        )}

                        {/* Likelihood of acceptance */}
                        <div>
                            <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'0.3rem' }}>
                                <span style={{ fontSize:'0.65rem', color:'var(--silver)', opacity:0.7, textTransform:'uppercase', letterSpacing:'0.06em' }}>Likelihood of Acceptance</span>
                                <span style={{ fontFamily:'Bebas Neue,cursive', fontSize:'1.4rem', color: likelihoodColor }}>{likelihood}%</span>
                            </div>
                            <div className="likelihood-bar-wrap">
                                <div className="likelihood-bar-fill" style={{ width:`${likelihood}%`, background: likelihoodColor }} />
                            </div>
                        </div>

                        {/* ── Outcome Flow ── */}
                        {myOwnerId && otherOwnerId && (() => {
                            // Counter-offer live verdict
                            const cTotA = tradeSideValue(counterIds.A);
                            const cTotB = tradeSideValue(counterIds.B);
                            const cDiff = cTotA - cTotB;
                            const cMargin = Math.round(Math.max(cTotA, cTotB) * 0.04);
                            const cVerdict = Math.abs(cDiff) <= cMargin ? 'FAIR'
                                : cDiff > cMargin ? 'LOWBALL' : 'OVERPAY';
                            const cColor = cVerdict==='FAIR' ? 'var(--win-green)'
                                : cVerdict==='LOWBALL' ? 'var(--loss-red)' : '#5DADE2';

                            function handleAcceptedResult(grudgeType, resultLabel, resultColor) {
                                logGrudge(grudgeType);
                                setTradeResult({ label: resultLabel, color: resultColor, grudgeType });
                                setOutcomeStep('done');
                            }

                            function resetTrade() {
                                setTradeIds({ A:[], B:[] });
                                setTradeOwner(prev => ({ A: myAssessment?.ownerId || null, B: null }));
                                setSearchText({ A:'', B:'' });
                                setOutcomeStep(null);
                                setTradeResult(null);
                            }

                            return (
                                <div style={{ display:'flex', flexDirection:'column', gap:'0.5rem' }}>
                                    <div className="log-section-hdr">TRADE OUTCOME</div>

                                    {/* ── Step 0: Three primary outcome buttons ── */}
                                    {outcomeStep === null && (
                                        <div className="outcome-row">
                                            <button className="outcome-btn primary" onClick={() => setOutcomeStep('accepted')}>✓ Accepted</button>
                                            <button className="outcome-btn danger"  onClick={() => { logGrudge('REJECTED'); }}>✗ Rejected</button>
                                            <button className="outcome-btn neutral" onClick={() => {
                                                setCounterIds({ A:[...tradeIds.A], B:[...tradeIds.B] });
                                                setCounterSearch({ A:'', B:'' });
                                                setOutcomeStep('counter');
                                            }}>↔ Counter-Offer</button>
                                        </div>
                                    )}

                                    {/* ── Step 1a: Accepted — how did it go? ── */}
                                    {outcomeStep === 'accepted' && (
                                        <div style={{ display:'flex', flexDirection:'column', gap:'0.4rem' }}>
                                            <div className="outcome-question">Trade accepted — how did it go for you?</div>
                                            <div className="outcome-row">
                                                <button className="outcome-btn primary" onClick={() => handleAcceptedResult('ACCEPTED_FAIR', 'FAIR TRADE', 'var(--win-green)')}>✓ Fair</button>
                                                <button className="outcome-btn amber"   onClick={() => handleAcceptedResult('ACCEPTED_WON',  'YOU FLEECED THEM', '#F0A500')}>⬆ Fleeced Them</button>
                                                <button className="outcome-btn purple"  onClick={() => handleAcceptedResult('ACCEPTED_LOST', 'GOT FLEECED', '#BB8FCE')}>⬇ Got Fleeced</button>
                                            </div>
                                            <button className="back-link" onClick={() => setOutcomeStep(null)}>← Back</button>
                                        </div>
                                    )}

                                    {/* ── Step 1c: TRADE COMPLETE ── */}
                                    {outcomeStep === 'done' && tradeResult && (
                                        <div className="trade-complete">
                                            <div className="trade-complete-icon">✅</div>
                                            <div className="trade-complete-title">TRADE COMPLETE</div>
                                            <div className="trade-complete-result" style={{ color: tradeResult.color, background:`${tradeResult.color}18`, border:`1px solid ${tradeResult.color}40` }}>
                                                {tradeResult.label}
                                            </div>
                                            <div className="trade-players-wrap">
                                                <div className="trade-players-col">
                                                    <div className="trade-players-col-title">You gave</div>
                                                    {tradeIds.A.map(pid => {
                                                        const p = playersData[pid];
                                                        if (!p) return null;
                                                        return (
                                                            <div key={pid} className="trade-player-chip">
                                                                <span className="ta-pos-dot" style={{ background: posColor(normPos(p.position)) }} />
                                                                {p.first_name} {p.last_name}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                <div className="trade-players-col">
                                                    <div className="trade-players-col-title">You received</div>
                                                    {tradeIds.B.map(pid => {
                                                        const p = playersData[pid];
                                                        if (!p) return null;
                                                        return (
                                                            <div key={pid} className="trade-player-chip">
                                                                <span className="ta-pos-dot" style={{ background: posColor(normPos(p.position)) }} />
                                                                {p.first_name} {p.last_name}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                            <div className="trade-complete-sub">
                                                This outcome has been logged to the Grudge Log and will influence future acceptance likelihood calculations with this owner.
                                            </div>
                                            <button className="outcome-btn primary" onClick={resetTrade} style={{ marginTop:'0.25rem' }}>
                                                + Start New Trade
                                            </button>
                                        </div>
                                    )}

                                    {/* ── Step 1b: Counter-offer builder ── */}
                                    {outcomeStep === 'counter' && (
                                        <div style={{ display:'flex', flexDirection:'column', gap:'0.5rem' }}>
                                            <div className="outcome-question">Build their counter-offer — modify either side, then log the verdict:</div>
                                            <div className="ta-layout-wide">
                                                {['A','B'].map(side => {
                                                    const sideColor = side==='A' ? '#5DADE2' : '#E74C3C';
                                                    const cIds = counterIds[side];
                                                    const roster = allRosters.find(r => r.owner_id === tradeOwner[side]);
                                                    const q = counterSearch[side].toLowerCase().trim();
                                                    const rp = roster ? [
                                                        ...(roster.players||[]),...(roster.reserve||[]),...(roster.taxi||[])
                                                    ].filter(id => {
                                                        const p = playersData[id];
                                                        if (!p || !normPos(p.position)) return false;
                                                        if (q) { const f=`${p.first_name||''} ${p.last_name||''}`.toLowerCase(); return f.includes(q); }
                                                        return true;
                                                    }).map(id => {
                                                        const p = playersData[id];
                                                        const v = getPlayerValue(id, valueIndex);
                                                        return { id, name:`${p.first_name||''} ${p.last_name||''}`.trim(), pos:normPos(p.position), team:p.team||'FA', value:v.value };
                                                    }).sort((a,b)=>b.value-a.value) : null;

                                                    return (
                                                        <div key={side} className={`ta-side side-${side.toLowerCase()}`} style={{ gap:'0.3rem' }}>
                                                            <div style={{ fontSize:'0.7rem', fontWeight:700, color:sideColor }}>
                                                                {side==='A' ? 'SIDE A — YOUR GIVE' : 'SIDE B — THEIR OFFER'}
                                                            </div>
                                                            {cIds.map(pid => {
                                                                const p = playersData[pid]; if (!p) return null;
                                                                const v = getPlayerValue(pid, valueIndex);
                                                                return (
                                                                    <div key={pid} className="ta-player-row">
                                                                        <button className="ta-remove" onClick={() => setCounterIds(prev=>({...prev,[side]:prev[side].filter(x=>x!==pid)}))}>✕</button>
                                                                        <span className="ta-pos-dot" style={{ background:posColor(normPos(p.position)) }} />
                                                                        <span style={{ flex:1, fontSize:'0.7rem', fontWeight:600, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' }}>{p.first_name} {p.last_name}</span>
                                                                        <span style={{ fontSize:'0.6rem', fontWeight:700, color:sideColor }}>{v.value>0?v.value.toLocaleString():'—'}</span>
                                                                    </div>
                                                                );
                                                            })}
                                                            {rp !== null ? (
                                                                <div>
                                                                    <input className="ta-roster-filter" placeholder="Filter roster…"
                                                                        value={counterSearch[side]}
                                                                        onChange={e => setCounterSearch(prev=>({...prev,[side]:e.target.value}))} />
                                                                    <div className="ta-roster-list" style={{ maxHeight:120 }}>
                                                                        {rp.slice(0,20).map(r => {
                                                                            const added = cIds.includes(r.id);
                                                                            return (
                                                                                <div key={r.id} className={`ta-roster-item${added?' added':''}`}
                                                                                    onClick={() => !added && setCounterIds(prev=>({...prev,[side]:[...prev[side],r.id]}))}>
                                                                                    <span className="ta-pos-dot" style={{ background:posColor(r.pos) }} />
                                                                                    <span style={{ flex:1, fontSize:'0.68rem', fontWeight:600, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' }}>{r.name}</span>
                                                                                    <span className="ta-player-meta">{r.pos}·{r.team}</span>
                                                                                    <span className="ta-player-val">{r.value>0?r.value.toLocaleString():'—'}</span>
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <div style={{ fontSize:'0.6rem', color:'var(--silver)', opacity:0.35 }}>Select an owner above to filter by roster</div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>

                                            {/* Live counter verdict */}
                                            {(cTotA > 0 || cTotB > 0) && (
                                                <div className="counter-verdict-row" style={{ background:`${cColor}10`, border:`1px solid ${cColor}30` }}>
                                                    <span style={{ fontFamily:'Bebas Neue,cursive', fontSize:'1.3rem', color:cColor }}>{cVerdict}</span>
                                                    <div style={{ fontSize:'0.62rem', color:'var(--silver)', opacity:0.7 }}>
                                                        <div>{cTotA.toLocaleString()} vs {cTotB.toLocaleString()}</div>
                                                        <div>diff {cDiff>0?'+':''}{cDiff.toLocaleString()} · fair band ±{cMargin.toLocaleString()}</div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Counter log + bring to analyzer */}
                                            <div className="outcome-row">
                                                <button className="outcome-btn primary" onClick={() => { logGrudge('COUNTER_FAIR');    setOutcomeStep(null); }}>✓ Log Fair Counter</button>
                                                <button className="outcome-btn danger"  onClick={() => { logGrudge('COUNTER_LOWBALL'); setOutcomeStep(null); }}>↓ Log Lowball Counter</button>
                                                <button className="outcome-btn gold"    onClick={() => { setTradeIds({ A:[...counterIds.A], B:[...counterIds.B] }); setOutcomeStep(null); }}>⬆ Load into Analyzer</button>
                                            </div>
                                            <button className="back-link" onClick={() => setOutcomeStep(null)}>← Back</button>
                                        </div>
                                    )}

                                    {/* History entries (shown on step 0 only) */}
                                    {outcomeStep === null && grudgeTax.entries.length > 0 && (
                                        <div className="grudge-log">
                                            {grudgeTax.entries.slice(0,5).map(e => {
                                                const gt = GRUDGE_TYPES[e.type];
                                                const ageDays = Math.round((Date.now()-new Date(e.date).getTime())/86400000);
                                                const dnaMult = {FLEECER:0.7,DOMINATOR:1.6,STALWART:1.2,ACCEPTOR:0.8,DESPERATE:0.5,NONE:1.0}[otherDnaKey]||1.0;
                                                const eff = Math.round((gt?.impact||0)*grudgeDecay(ageDays)*dnaMult);
                                                return (
                                                    <div key={e.id} className="grudge-entry">
                                                        <span className="grudge-icon" style={{ color:gt?.color }}>{gt?.icon}</span>
                                                        <span className="grudge-label" style={{ color:gt?.color }}>{gt?.label}</span>
                                                        <span className="grudge-date">{e.date} · {ageDays}d</span>
                                                        <span className="grudge-impact" style={{ color:eff<0?'var(--loss-red)':'var(--win-green)' }}>{eff>0?'+':''}{eff}</span>
                                                        <button className="grudge-del" onClick={() => deleteGrudge(e.id)}>✕</button>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );
                        })()}
                    </div>
                )}
            </div>
        );
    }

    // ── FULL RENDER ───────────────────────────────────────────────────────────
    return (
        <div style={{ display:'flex', flexDirection:'column', minHeight:'100vh' }}>
            {/* Header */}
            <div className="page-header">
                <button className="back-btn" onClick={() => window.location.href='index.html'}>← Main</button>
                <div className="page-title">Behavioral Trade Calculator</div>
                <select
                    className="league-select"
                    value={leagueId}
                    onChange={e => setLeagueId(e.target.value)}
                >
                    {leagues.map(l => (
                        <option key={l.league_id} value={l.league_id}>{l.name}</option>
                    ))}
                </select>
            </div>

            {/* Tab Bar */}
            <div className="tab-bar">
                {[
                    { key:'guide',   label:'How to Use'    },
                    { key:'audit',   label:'Roster Audit'  },
                    { key:'dna',     label:'Owner DNA'     },
                    { key:'analyzer',label:'Trade Analyzer'},
                ].map(t => (
                    <button
                        key={t.key}
                        className={`tab-btn${activeTab===t.key?' active':''}`}
                        onClick={() => setActiveTab(t.key)}
                    >
                        {t.label}
                    </button>
                ))}
            </div>

            {/* Tab Content */}
            <div className="tab-content" style={{ flex:1, paddingBottom:'2rem' }}>
                {activeTab === 'guide'    && renderGuide()}
                {activeTab === 'audit'    && renderAudit()}
                {activeTab === 'analyzer' && renderTradeAnalyzer()}
                {activeTab === 'dna'      && renderOwnerDna()}
            </div>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(TradeCalculator));
</script>
</body>
</html>
